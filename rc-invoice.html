<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" 
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer">
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- A4 Page/Print Configuration --- */
        /* Forces the output to be exactly A4 size */
        @page {
            size: A4;
            margin: 0;
        }

        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f4f4f9; 
            font-size: 10pt; /* Default font size for A4 print optimization */
        }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        
        /* --- Form Styles --- (Kept similar for functionality) */
        #invoice-input-form h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; }
        .input-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; }
        .input-item { flex: 1 1 45%; min-width: 250px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
            font-size: 14px;
        }
        .btn-generate { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background-color: #007bff; color: white; }
        .signature-options { padding: 10px; border: 1px dashed #ccc; border-radius: 4px; margin-top: 15px; }

        /* --- Invoice Output Area (Refined to match image design) --- */
        #invoice-output { 
            display: none; 
            box-sizing: border-box;
            width: 210mm; /* A4 Width */
            min-height: 297mm; /* A4 Height */
            margin: 0 auto;
            border: none; 
            padding: 0; 
            box-shadow: none;
            background-color: #fff;
        }

        /* Dark Blue Header Section */
        .header-bg {
            background-color: #1a4d80; /* Dark Blue */
            color: white;
            padding: 20px 40px;
            overflow: hidden; /* Contains the curved shape */
            position: relative;
        }
        .header-bg h2 {
            font-size: 30pt;
            margin: 0;
            padding: 0;
            font-weight: bold;
            float: left;
        }
        .header-bg .invoice-no {
            font-size: 14pt;
            float: right;
            margin-top: 15px;
            font-weight: bold;
        }
        /* Curved white shape overlaying the dark blue header */
        .curve {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 100% 0, transparent 400px, white 400px),
                linear-gradient(to right bottom, transparent 50%, white 50%);
            background-size: 100% 100%;
            clip-path: polygon(0 0, 100% 0, 100% 70%, 50% 100%, 0 70%);
            opacity: 0.1; /* subtle effect */
        }


        /* Bill To / From Section */
        .address-section {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .address-section div {
            flex-basis: 48%;
            padding: 10px;
        }
        .address-section h3 {
            font-size: 12pt;
            font-weight: bold;
            margin-bottom: 10px;
            color: #1a4d80; /* Dark Blue */
        }
        .address-section p { margin: 2px 0; font-size: 10pt; }
        .recipient-details { text-align: left; }
        .issuer-details { text-align: right; }

        /* Date and CIN/Bank Details Section */
        .meta-data {
            padding: 0 40px;
            margin-bottom: 20px;
        }
        .meta-data p { margin: 5px 0; font-weight: bold; font-size: 10pt; }

        /* Items Table Output */
        .invoice-table-output { 
            width: calc(100% - 80px); /* 100% minus 2*40px padding */
            margin: 0 40px; 
            border-collapse: collapse;
        }
        .invoice-table-output thead th { 
            background-color: #1a4d80; /* Dark Blue */
            color: white; 
            padding: 10px; 
            font-weight: bold;
            border: none;
        }
        .invoice-table-output td { 
            border: 1px solid #ddd; 
            padding: 8px 10px; 
            text-align: left;
        }
        .invoice-table-output .output-amount,
        .invoice-table-output .output-qty,
        .invoice-table-output .output-price { text-align: right; }

        /* Totals Block */
        .total-and-footer {
            display: flex;
            justify-content: space-between;
            padding: 0 40px;
            margin-top: 20px;
        }
        .output-totals {
            width: 300px;
            text-align: right;
            border-top: 3px solid #1a4d80;
        }
        .output-totals .total-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 11pt;
            font-weight: bold;
        }
        .output-totals .total-row:last-child {
            font-size: 12pt;
            color: #1a4d80;
            padding-top: 10px;
        }

        /* Note and Thank You Section */
        .notes-and-payment {
            flex-basis: 60%;
            text-align: left;
            margin-top: 10px;
        }
        .notes-and-payment h4 {
            font-size: 11pt;
            color: #1a4d80;
            margin-bottom: 5px;
        }
        .thank-you {
            font-family: 'Dancing Script', cursive;
            font-size: 36pt;
            color: #1a4d80;
            text-align: right;
            margin-top: 40px;
            margin-right: 40px;
        }

        /* Signature Block */
        .signature-block { 
            padding: 0 40px; 
            margin-top: 40px; 
            text-align: right; 
        }
        .manual-signature-line { 
            border-bottom: 1px solid #333; 
            width: 200px; 
            margin-left: auto;
            margin-bottom: 5px;
        }
        .signature-date-output { 
            font-style: italic; 
            font-size: 9pt; 
            margin-top: 5px;
        }

        /* Print/PDF Specific Styles */
        @media print {
            body { 
                background-color: #fff; 
                padding: 0 !important;
                margin: 0 !important;
            }
            .container, .button-group, #invoice-input-form { 
                display: none !important; 
            }
            #invoice-output { 
                display: block !important; 
                margin: 0;
                box-shadow: none;
                /* Ensure it takes up the full A4 space */
                width: 210mm;
                min-height: 297mm;
            }
            .invoice-table-output td { 
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Freelancer Invoice Generator</h1>

        <div id="invoice-input-form">
            <h2>Your Details (Invoice Issuer - "From")</h2>
            <div class="input-group">
                <div class="input-item"><label for="issuer-name">Your Name/Company</label><input type="text" id="issuer-name" value="Samira Hadid" required></div>
                <div class="input-item"><label for="issuer-address">Your Address</label><textarea id="issuer-address" rows="2">123 Anywhere St., Any City</textarea></div>
                <div class="input-item"><label for="issuer-pan">PAN Card No. (Optional)</label><input type="text" id="issuer-pan" value=""></div>
            </div>

            <h2>Recipient Details (Bill To)</h2>
            <div class="input-group">
                <div class="input-item"><label>Company Name</label><input type="text" value="Redcoupons Private Limited" readonly></div>
                <div class="input-item"><label>CIN</label><input type="text" value="U73100RJ2024PTC098563" readonly></div>
                <div class="input-item" style="flex: 1 1 100%;"><label>Address</label><textarea id="recipient-address" rows="2" readonly>Ward No. 29, Pani Tanki Ke Pass, Nokha, Bikaner, Nokha, Rajasthan, India, 334803</textarea></div>
            </div>

            <h2>Invoice & Payment Details</h2>
            <div class="input-group">
                <div class="input-item"><label for="invoice-date">Invoice Date</label><input type="date" id="invoice-date" value="2025-10-05" required></div>
                <div class="input-item"><label for="invoice-number">Invoice Number</label><input type="text" id="invoice-number" value="" required></div>
                <div class="input-item"><label for="issuer-account">Bank A/C No.</label><input type="text" id="issuer-account" value=""></div>
                <div class="input-item"><label for="issuer-ifsc">IFSC Code</label><input type="text" id="issuer-ifsc" value=""></div>
                <div class="input-item"><label for="signature-date">Signature Date (Date of Invoice)</label><input type="date" id="signature-date" value="2025-10-05"></div>
            </div>

            <h2>Invoice Particulars</h2>
            <table id="invoice-items-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Description</th>
                        <th style="width: 15%;">Qty</th>
                        <th style="width: 20%;">Price (₹)</th>
                        <th style="width: 25%;">Amount (₹)</th>
                    </tr>
                </thead>
                <tbody id="invoice-items-body">
                    <tr class="item-row">
                        <td><input type="text" class="description" placeholder="Service Description" value="Online Content Writing for Month /2025"></td>
                        <td><input type="number" class="qty" value="1" min="1"></td>
                        <td><input type="number" class="price" value="50000" min="0" step="0.01"></td>
                        <td class="amount">0.00</td>
                    </tr>
                </tbody>
            </table>
            <div class="button-group" style="text-align: left;">
                <button class="btn btn-add" onclick="addItemRow()">+ Add Item</button>
            </div>

            <div class="invoice-totals">
                <div class="total-row"><span>Sub Total:</span> <span id="sub-total-input">₹0.00</span></div>
                <div class="total-row"><span>**Total Amount:**</span> <span id="grand-total-input">**₹0.00**</span></div>
            </div>

            <div class="words-section">
                <p>Total Amount in Words:</p>
                <p id="total-in-words">**Zero Rupees Only**</p>
            </div>

            <div class="button-group">
                <button class="btn btn-generate" onclick="generateInvoicePDF()">Generate Invoice PDF & Download</button>
            </div>
        </div>
        
        <div id="invoice-output">
            <div class="header-bg">
                <h2>INVOICE</h2>
                <div class="invoice-no">NO: <span id="output-invoice-number"></span></div>
                </div>

            <div class="address-section">
                <div class="recipient-details">
                    <h3>Bill To:</h3>
                    <strong>Redcoupons Private Limited</strong>
                    <p>CIN: U73100RJ2024PTC098563</p>
                    <p id="output-recipient-address"></p>
                </div>
                <div class="issuer-details">
                    <h3>From:</h3>
                    <strong id="output-issuer-name"></strong>
                    <p id="output-issuer-address"></p>
                </div>
            </div>

            <div class="meta-data">
                <p>Date: <span id="output-invoice-date"></span></p>
            </div>

            <table class="invoice-table-output">
                <thead>
                    <tr>
                        <th style="width: 50%;">Description</th>
                        <th style="width: 10%; text-align: right;">Qty</th>
                        <th style="width: 20%; text-align: right;">Price (₹)</th>
                        <th style="width: 20%; text-align: right;">Total (₹)</th>
                    </tr>
                </thead>
                <tbody id="output-items-body">
                    </tbody>
            </table>

            <div class="total-and-footer">
                <div class="notes-and-payment">
                    <h4>Payment Information:</h4>
                    <p style="margin-top: 10px;">Bank: **[Your Bank Name]**</p>
                    <p>A/C No: <span id="output-account"></span></p>
                    <p>IFSC: <span id="output-ifsc"></span></p>
                    <p>PAN: <span id="output-issuer-pan"></span></p>
                    
                    <h4 style="margin-top: 20px;">Notes:</h4>
                    <p style="border-bottom: 1px solid #ddd; width: 80%; padding-bottom: 5px; margin-top: 5px;">Payment due within 7 days of invoice date.</p>
                </div>

                <div class="output-totals">
                    <div class="total-row"><span>Sub Total:</span> <span id="output-sub-total">₹0.00</span></div>
                    <div class="total-row"><span>**Total Amount:**</span> <span id="output-grand-total">**₹0.00**</span></div>
                </div>
            </div>
            
            <p class="thank-you">Thank You!</p>

            <div class="signature-block">
                <div class="manual-signature-line"></div>
                <p class="signature-date-output">For: <span id="output-signature-name"></span></p>
                <p class="signature-date-output">Date of Invoice: <span id="output-signature-date"></span></p>
                <p>Authorised Signatory</p>
            </div>
        </div>
    </div>

    <script>
        // --- Core Functions ---
        function calculateRowTotal(row) {
            const qty = parseFloat(row.querySelector('.qty').value) || 0;
            const price = parseFloat(row.querySelector('.price').value) || 0;
            const amount = qty * price;
            row.querySelector('.amount').textContent = amount.toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let subTotal = 0;
            const itemRows = document.querySelectorAll('#invoice-items-body .item-row');
            itemRows.forEach(row => {
                const amountText = row.querySelector('.amount').textContent;
                subTotal += parseFloat(amountText) || 0;
            });

            // Update display totals
            document.getElementById('sub-total-input').textContent = `₹${subTotal.toFixed(2)}`;
            document.getElementById('grand-total-input').textContent = `**₹${subTotal.toFixed(2)}**`;

            // Convert to words and update display
            const words = numberToWords.toWords(subTotal);
            document.getElementById('total-in-words').innerHTML = `**${words.toUpperCase()} RUPEES ONLY**`;
        }

        function addItemRow() {
            const tbody = document.getElementById('invoice-items-body');
            const newRow = document.createElement('tr');
            newRow.classList.add('item-row');
            newRow.innerHTML = `
                <td><input type="text" class="description" placeholder="Service Description" value="Online Content Writing for Month /2025"></td>
                <td><input type="number" class="qty" value="1" min="1"></td>
                <td><input type="number" class="price" value="0" min="0" step="0.01"></td>
                <td class="amount">0.00</td>
            `;
            tbody.appendChild(newRow);
            addEventListenersToRow(newRow);
            calculateGrandTotal(); 
        }

        function addEventListenersToRow(row) {
            const qtyInput = row.querySelector('.qty');
            const priceInput = row.querySelector('.price');
            const handler = () => calculateRowTotal(row);
            qtyInput.addEventListener('input', handler);
            priceInput.addEventListener('input', handler);
        }

        function populateInvoiceOutput() {
            // 1. Get Input Values
            const issuerName = document.getElementById('issuer-name').value;
            const invoiceDate = document.getElementById('invoice-date').value;
            const signatureDate = document.getElementById('signature-date').value;
            const recipientAddress = document.getElementById('recipient-address').value.replace(/\n/g, '<br>');
            
            // 2. Populate Header Details
            document.getElementById('output-issuer-name').textContent = issuerName;
            document.getElementById('output-issuer-address').textContent = document.getElementById('issuer-address').value;
            document.getElementById('output-issuer-pan').textContent = document.getElementById('issuer-pan').value || 'N/A';
            document.getElementById('output-account').textContent = document.getElementById('issuer-account').value || 'N/A';
            document.getElementById('output-ifsc').textContent = document.getElementById('issuer-ifsc').value || 'N/A';
            document.getElementById('output-invoice-number').textContent = document.getElementById('invoice-number').value;
            document.getElementById('output-recipient-address').innerHTML = recipientAddress;
            
            // Format Dates
            const dateFormatter = new Intl.DateTimeFormat('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('output-invoice-date').textContent = dateFormatter.format(new Date(invoiceDate));
            document.getElementById('output-signature-date').textContent = dateFormatter.format(new Date(signatureDate));
            
            document.getElementById('output-signature-name').textContent = issuerName;

            // 3. Populate Items Table
            const outputBody = document.getElementById('output-items-body');
            outputBody.innerHTML = ''; 

            const itemRows = document.querySelectorAll('#invoice-items-body .item-row');
            itemRows.forEach(row => {
                const description = row.querySelector('.description').value;
                const qty = row.querySelector('.qty').value;
                const price = parseFloat(row.querySelector('.price').value).toFixed(2);
                const amount = row.querySelector('.amount').textContent;

                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${description}</td>
                    <td class="output-amount output-qty">${qty}</td>
                    <td class="output-amount output-price">${price}</td>
                    <td class="output-amount">${amount}</td>
                `;
                outputBody.appendChild(newRow);
            });
            
            // 4. Populate Totals
            document.getElementById('output-sub-total').textContent = document.getElementById('sub-total-input').textContent;
            document.getElementById('output-grand-total').textContent = document.getElementById('grand-total-input').textContent;
        }

        /**
         * Generates the PDF, includes the fix for blank PDF generation.
         */
        function generateInvoicePDF() {
            // 1. Calculate and populate
            calculateGrandTotal();
            populateInvoiceOutput();

            const element = document.getElementById('invoice-output');
            
            // **PDF FIX:** Temporarily make the element visible before generation starts
            element.style.display = 'block';

            // 2. Configure html2pdf options (Set format to A4 explicitly)
            const options = {
                margin: 0, // Set to 0 because we're controlling margins via CSS
                filename: `Invoice.pdf`, 
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    logging: true, 
                    dpi: 192, 
                    letterRendering: true,
                    useCORS: true 
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', // Explicitly set A4 format
                    orientation: 'portrait' 
                }
            };

            // 3. Generate and download the PDF
            html2pdf().set(options).from(element).save().then(() => {
                // **PDF FIX:** Hide the element again after the PDF is generated/downloaded
                element.style.display = 'none';
            });
        }

        // --- Third-party library for number-to-words conversion (included here for simplicity) ---
        const numberToWords = (function () {
            // ... (numberToWords function content is omitted for brevity but is included in the full code)
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            const ntw = function (num) {
                if ((num = num.toString()).length > 9) return 'overflow';
                const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
                if (!n) return;
                let str = '';
                str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
                str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
                str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
                str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
                str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + '' : '';
                return str.trim();
            };

            return {
                toWords: function (num) {
                    const integer = Math.floor(num);
                    const decimal = Math.round((num - integer) * 100);
                    let result = ntw(integer);
                    if (decimal > 0) {
                        result += ' and ' + ntw(decimal) + ' paisa';
                    }
                    return result || 'Zero';
                }
            };
        })();

        // --- Initial Setup ---
        window.onload = function() {
            document.querySelectorAll('#invoice-items-body .item-row').forEach(addEventListenersToRow);
            calculateGrandTotal();
        };

    </script>

</body>
</html>
