<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Salary Calculator (Updated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .input-field {
            @apply block w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5;
        }
        .input-field-readonly {
            @apply block w-full bg-gray-200 border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 cursor-not-allowed;
        }
        .output-field {
            @apply text-lg font-semibold text-gray-900;
        }
        .output-label {
            @apply text-sm font-medium text-gray-500;
        }
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg;
        }
        .final-amount {
            @apply text-3xl font-bold text-blue-600;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Advanced Salary Calculator (v2)</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Left Column: Main Inputs & Daily Tracker -->
            <div class="md:col-span-2 space-y-6">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Employee & Salary Details</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <!-- Basic Inputs -->
                        <div class="sm:col-span-1">
                            <label for="name" class="input-label">Name</label>
                            <input type="text" id="name" class="input-field" placeholder="Input Name">
                        </div>
                        <div>
                            <label for="daysInMonth" class="input-label">Month Days</label>
                            <select id="daysInMonth" class="input-field">
                                <option value="31">31</option>
                                <option value="30">30</option>
                                <option value="29">29</option>
                                <option value="28">28</option>
                            </select>
                        </div>
                         <div>
                            <label for="officeLeave" class="input-label">Office Leave (Days)</label>
                            <input type="number" id="officeLeave" class="input-field" placeholder="0" value="0">
                        </div>
                        <div>
                            <label for="basicSalary" class="input-label">Basic Salary</label>
                            <input type="number" id="basicSalary" class="input-field" placeholder="0" value="0">
                        </div>
                        <div>
                            <label for="additionalPayout" class="input-label">Additional Payout</label>
                            <select id="additionalPayout" class="input-field">
                                <option value="0" selected>0</option>
                                <option value="500">500</option>
                                <option value="1500">1500</option>
                            </select>
                        </div>

                        <!-- Attendance Inputs -->
                        <div class="sm:col-span-3 mt-4">
                             <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Attendance & Leave Calculation</h3>
                        </div>
                        <div>
                            <label for="presentDays" class="input-label">Total Present Days (Calculated)</label>
                            <input type="number" id="presentDays" class="input-field-readonly" value="0.00" readonly>
                             <p class="text-xs text-gray-500 mt-1">Total days worked, derived from daily hours.</p>
                        </div>
                         <div>
                            <label for="lateIns" class="input-label">Total Late-ins</label>
                            <input type="number" id="lateIns" class="input-field" placeholder="0" value="0">
                             <p class="text-xs text-gray-500 mt-1">Leave deduction auto-calculated.</p>
                        </div>
                         <div>
                            <label for="shortDurationPenaltyDays" class="input-label">Short Duration Deduction (Days)</label>
                            <input type="number" id="shortDurationPenaltyDays" class="input-field-readonly" value="0.00" readonly>
                            <p class="text-xs text-gray-500 mt-1">Less hours converted to day deduction.</p>
                        </div>
                        <div>
                            <label for="continuousLatePenaltyDays" class="input-label">3 Continue Late-in (Instances)</label>
                            <input type="number" id="continuousLatePenaltyDays" class="input-field" placeholder="0" value="0">
                             <p class="text-xs text-gray-500 mt-1">Deducts 0.5 day per instance.</p>
                        </div>
                        <div>
                            <label for="noInformLeave" class="input-label">No-inform Leave (Instances)</label>
                            <input type="number" id="noInformLeave" class="input-field" placeholder="0" value="0">
                            <p class="text-xs text-gray-500 mt-1">Deducts 0.5 day per instance.</p>
                        </div>
                         <div>
                            <label for="allowedLeaveCredit" class="input-label">Allowed Leave (Credit)</label>
                            <input type="number" id="allowedLeaveCredit" class="input-field-readonly" value="0.00" readonly>
                             <p class="text-xs text-gray-500 mt-1">Conditional calculation based on Preliminary Payable Days vs 30 days.</p>
                        </div>

                        <!-- Bonus Inputs -->
                         <div class="sm:col-span-3 mt-4">
                             <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Bonus & Other Adjustments</h3>
                        </div>
                        <div>
                            <label for="bonusScale" class="input-label">Bonus Scale</label>
                            <select id="bonusScale" class="input-field">
                                <option value="1">100%</option>
                                <option value="0.5">50%</option>
                                <option value="0" selected>0%</option>
                            </select>
                        </div>
                        <div>
                            <label for="noLeaveBonus" class="input-label">No Leave Bonus</label>
                            <input type="text" id="noLeaveBonus" class="input-field-readonly" value="₹0.00" readonly>
                        </div>
                         <div>
                            <label for="noLateInBonus" class="input-label">No Late-in Bonus</label>
                            <input type="text" id="noLateInBonus" class="input-field-readonly" value="₹0.00" readonly>
                        </div>
                         <div>
                            <label for="anyOther" class="input-label">Any Other (Bonus/Deduction)</label>
                            <input type="number" id="anyOther" class="input-field" placeholder="0" value="0">
                        </div>
                        <div>
                            <label for="top3" class="input-label">Top 3 Bonus</label>
                            <input type="number" id="top3" class="input-field" placeholder="0" value="0">
                        </div>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Daily Present Hours (Full Hours, Rounded Down)</h2>
                    <div>
                        <label for="dailyWorkingTime" class="input-label">Daily Working Time (Required Hours)</label>
                        <select id="dailyWorkingTime" class="input-field mb-4">
                            <option value="9">9 Hours</option>
                            <option value="6">6 Hours</option>
                            <option value="4.5">4.5 Hours</option>
                        </select>
                    </div>
                    <!-- The total sum of hours is crucial for calculating Office Days -->
                    <div class="flex justify-between items-center mb-4 pb-2 border-b">
                            <span class="output-label font-bold text-gray-800">Total Present Hours (All 31 Days)</span>
                            <span id="totalPresentHours" class="output-field">0</span>
                    </div>
                    <div id="dailyHoursContainer" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-2 pr-2">
                        <!-- JS will populate this -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="md:col-span-1 space-y-6">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Calculation Summary</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="output-label">Total Salary (Basic + Add.)</span>
                            <span id="totalSalary" class="output-field">₹0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <!-- Office Days = Total Hours / Daily Working Time (New Formula) -->
                            <span class="output-label font-bold text-blue-800">Office Days (Calculated)</span> 
                            <span id="officeDays" class="output-field">0.00</span>
                        </div>
                        <hr/>
                        <div class="flex justify-between items-center">
                            <span class="output-label text-red-600">Short Duration (Days Deduction)</span>
                            <span id="summaryShortDuration" class="output-field text-red-600">-0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="output-label text-red-600">Late-in Leave (Days)</span>
                            <span id="summaryLateIn" class="output-field text-red-600">-0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="output-label text-red-600">3 Continue Late-in (Days)</span>
                            <span id="summaryContinuousLate" class="output-field text-red-600">-0.00</span>
                        </div>
                         <div class="flex justify-between items-center">
                            <span class="output-label text-red-600">No-inform Leave (Days)</span>
                            <span id="summaryNoInform" class="output-field text-red-600">-0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="output-label text-green-600">Allowed Leave (Credit)</span>
                            <span id="summaryAllowedLeave" class="output-field text-green-600">+0.00</span>
                        </div>
                        <hr/>
                        <div class="flex justify-between items-center">
                            <span class="output-label font-bold">Payable Days (Conditional Max)</span>
                            <span id="payableDays" class="output-field font-bold text-blue-600">0.00</span>
                        </div>
                        <hr/>
                         <div class="flex justify-between items-center">
                            <span class="output-label">Salary Payable</span>
                            <span id="salaryPayable" class="output-field">₹0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="output-label text-green-600">No Leave Bonus</span>
                            <span id="summaryNoLeaveBonus" class="output-field text-green-600">+ ₹0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="output-label text-green-600">No Late-in Bonus</span>
                            <span id="summaryNoLateInBonus" class="output-field text-green-600">+ ₹0.00</span>
                        </div>
                        <hr/>
                        <div class="text-center mt-4 bg-blue-50 p-4 rounded-lg">
                            <span class="output-label">Final Amount Payable</span>
                            <p id="finalAmountPayable" class="final-amount">₹0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Element References ---
            const inputs = {
                basicSalary: document.getElementById('basicSalary'),
                additionalPayout: document.getElementById('additionalPayout'),
                daysInMonth: document.getElementById('daysInMonth'),
                officeLeave: document.getElementById('officeLeave'),
                presentDays: document.getElementById('presentDays'), // Now a calculated output
                shortDurationPenaltyDays: document.getElementById('shortDurationPenaltyDays'),
                lateIns: document.getElementById('lateIns'),
                continuousLatePenaltyDays: document.getElementById('continuousLatePenaltyDays'),
                noInformLeave: document.getElementById('noInformLeave'),
                allowedLeaveCredit: document.getElementById('allowedLeaveCredit'),
                bonusScale: document.getElementById('bonusScale'),
                noLeaveBonus: document.getElementById('noLeaveBonus'),
                noLateInBonus: document.getElementById('noLateInBonus'),
                anyOther: document.getElementById('anyOther'),
                top3: document.getElementById('top3'),
                dailyWorkingTime: document.getElementById('dailyWorkingTime'),
            };

            const outputs = {
                totalSalary: document.getElementById('totalSalary'),
                officeDays: document.getElementById('officeDays'),
                payableDays: document.getElementById('payableDays'),
                salaryPayable: document.getElementById('salaryPayable'),
                finalAmountPayable: document.getElementById('finalAmountPayable'),
                totalPresentHours: document.getElementById('totalPresentHours'),
                summaryShortDuration: document.getElementById('summaryShortDuration'),
                summaryLateIn: document.getElementById('summaryLateIn'),
                summaryContinuousLate: document.getElementById('summaryContinuousLate'),
                summaryNoInform: document.getElementById('summaryNoInform'),
                summaryAllowedLeave: document.getElementById('summaryAllowedLeave'),
                summaryNoLeaveBonus: document.getElementById('summaryNoLeaveBonus'),
                summaryNoLateInBonus: document.getElementById('summaryNoLateInBonus'),
            };
            
            const dailyHoursContainer = document.getElementById('dailyHoursContainer');

            // --- Helper Functions ---
            const formatCurrency = (value) => `₹${(value || 0).toFixed(2)}`;
            const getNumberValue = (element) => parseFloat(element.value) || 0;

            // --- Core Calculation Logic ---
            function calculateSalary() {
                // 1. Get all input values
                const basicSalary = getNumberValue(inputs.basicSalary);
                const additionalPayout = getNumberValue(inputs.additionalPayout);
                const daysInMonth = getNumberValue(inputs.daysInMonth);
                const officeLeave = getNumberValue(inputs.officeLeave);
                const lateIns = getNumberValue(inputs.lateIns);
                const continuousLateInstances = getNumberValue(inputs.continuousLatePenaltyDays);
                const noInformLeaveInstances = getNumberValue(inputs.noInformLeave);
                const bonusScale = getNumberValue(inputs.bonusScale);
                const anyOther = getNumberValue(inputs.anyOther);
                const top3 = getNumberValue(inputs.top3);
                const dailyWorkingTimeHours = getNumberValue(inputs.dailyWorkingTime); // 9, 6, 4.5

                // 2. Calculate daily hours totals and short duration days
                const { totalHours, shortDurationDeductionDays, fullPresentDays } = calculateDailyAttendanceMetrics(dailyWorkingTimeHours);

                // Update the calculated Present Days and Short Duration fields
                inputs.presentDays.value = fullPresentDays.toFixed(2);
                inputs.shortDurationPenaltyDays.value = shortDurationDeductionDays.toFixed(2);
                outputs.totalPresentHours.textContent = totalHours.toFixed(0);

                // --- Base Values ---
                const totalSalary = basicSalary + additionalPayout;

                // Office Days = Total of Hours for all 31 Days / daily Working time (in hours)
                const officeDays = dailyWorkingTimeHours > 0 ? (totalHours / dailyWorkingTimeHours) : 0;

                // --- Calculate all static penalties ---
                
                // 1. Late-in Deduction (Old Logic Maintained)
                let lateInLeaveDeductionDays = 0;
                if (lateIns > 15) lateInLeaveDeductionDays = Math.ceil(lateIns / 5);
                else if (lateIns >= 9) lateInLeaveDeductionDays = 1;
                else if (lateIns >= 5) lateInLeaveDeductionDays = 0.5;

                // 2. Continuous Late-in Penalty
                const continuousLatePenalty = continuousLateInstances * 0.5;

                // 3. No-inform Leave Penalty
                const noInformLeavePenalty = noInformLeaveInstances * 0.5;

                // --- Allowed Leave Credit Base Calculation ---
                let baseAllowedLeaveCredit = 0;
                // Allowed Leave Credit criteria based on fullPresentDays (days >= 9 hours)
                if (fullPresentDays >= 25) baseAllowedLeaveCredit = 3;
                else if (fullPresentDays >= 20) baseAllowedLeaveCredit = 2;
                else if (fullPresentDays >= 14) baseAllowedLeaveCredit = 1;

                // --- Calculate Payable Days & Allowed Leave (CONDITIONAL LOGIC) ---

                // Total Deductions
                const totalDeductions = shortDurationDeductionDays + lateInLeaveDeductionDays + continuousLatePenalty + noInformLeavePenalty;
                
                // Preliminary Payable Days (PPD) = Office Days - Deductions + Office Leave
                // This is the value before applying the Allowed Leave Credit
                const preliminaryPayableDays = officeDays - totalDeductions + officeLeave;
                
                let allowedLeaveCreditApplied = 0;
                let payableDays = 0;
                let summaryAllowedLeaveText = "+0.00"; 

                // Conditional Calculation based on Preliminary Payable Days vs 30 days
                // If (Payable Days -less Allowed credit) is less then 30 days
                if (preliminaryPayableDays < 30) {
                    // Case 1: PPD < 30 (Apply Credit, Max cap is Month Days)
                    
                    // 1. Calculate Payable Days including allowed leave
                    payableDays = preliminaryPayableDays + baseAllowedLeaveCredit;
                    
                    // 2. Maximum Payable Days = month days
                    payableDays = Math.min(payableDays, daysInMonth);

                    // 3. Set credit applied amount and summary text
                    allowedLeaveCreditApplied = baseAllowedLeaveCredit;
                    summaryAllowedLeaveText = allowedLeaveCreditApplied > 0 ? `+${allowedLeaveCreditApplied.toFixed(2)}` : "+0.00";

                } else {
                    // Case 2: PPD >= 30 (Exclude Credit, No cap needed, Payable Days can be > Month Days)
                    
                    // 1. Calculate payable days excluding allowed leave
                    payableDays = preliminaryPayableDays;
                    
                    // 2. Show Allowed credit as - (0.00 in numerical input, -0.00 in summary)
                    allowedLeaveCreditApplied = 0; 
                    summaryAllowedLeaveText = "-0.00";
                }

                // Ensure final payable days is not negative
                if (payableDays < 0) {
                    payableDays = 0;
                }

                // Update credit input/output
                inputs.allowedLeaveCredit.value = allowedLeaveCreditApplied.toFixed(2);
                
                // --- Calculate Salary Payable ---
                const perDaySalary = daysInMonth > 0 ? totalSalary / daysInMonth : 0;
                const salaryPayable = perDaySalary * payableDays;
                
                // --- Auto-calculate Bonuses ---
                
                // NEW No Leave Bonus Logic: 
                // Payable if (Office days - Preliminary Payable Days) is less than 1.5 days.
                const bonusDifference = officeDays - preliminaryPayableDays;
                const isNoLeaveBonusPayable = bonusDifference < 1.5;

                const noLeaveBonusValue = isNoLeaveBonusPayable ? 500 * bonusScale : 0;
                // Update left side read-only input for consistency
                inputs.noLeaveBonus.value = formatCurrency(noLeaveBonusValue);
                
                const noLateInBonusValue = (lateIns <= 3) ? 400 * bonusScale : 0;
                // Update left side read-only input for consistency
                inputs.noLateInBonus.value = formatCurrency(noLateInBonusValue);

                // --- Calculate Final Amount ---
                const finalAmountPayable = salaryPayable + noLeaveBonusValue + noLateInBonusValue + anyOther + top3;

                // 3. Update the UI
                outputs.totalSalary.textContent = formatCurrency(totalSalary);
                outputs.officeDays.textContent = officeDays.toFixed(2);
                
                // Update summary breakdown
                outputs.summaryShortDuration.textContent = `-${shortDurationDeductionDays.toFixed(2)}`;
                outputs.summaryLateIn.textContent = `-${lateInLeaveDeductionDays.toFixed(2)}`;
                outputs.summaryContinuousLate.textContent = `-${continuousLatePenalty.toFixed(2)}`;
                outputs.summaryNoInform.textContent = `-${noInformLeavePenalty.toFixed(2)}`;
                outputs.summaryAllowedLeave.textContent = summaryAllowedLeaveText; // Use conditional text
                
                outputs.payableDays.textContent = payableDays.toFixed(2);
                outputs.salaryPayable.textContent = formatCurrency(salaryPayable);

                // Update the summary bonus fields
                outputs.summaryNoLeaveBonus.textContent = `+ ${formatCurrency(noLeaveBonusValue)}`;
                outputs.summaryNoLateInBonus.textContent = `+ ${formatCurrency(noLateInBonusValue)}`;

                outputs.finalAmountPayable.textContent = formatCurrency(finalAmountPayable);
            }
            
            function calculateDailyAttendanceMetrics(dailyWorkingTimeHours) {
                const hourInputs = dailyHoursContainer.querySelectorAll('input');
                let totalHours = 0;
                let totalShortHours = 0; // The total hours less than required
                let fullPresentDays = 0;

                hourInputs.forEach(input => {
                    const hoursWorked = getNumberValue(input);
                    
                    if (hoursWorked > 0) {
                        totalHours += hoursWorked;

                        // Check for days where the present hours are less than the daily working time
                        if (hoursWorked < dailyWorkingTimeHours) {
                            // Calculate the difference/shortage for that day
                            const shortage = dailyWorkingTimeHours - hoursWorked;
                            totalShortHours += shortage;
                        }

                        // For Allowed Leave Credit calculation: Day counts as present if hours >= 9 (assuming 9 hours is standard full day)
                        if (hoursWorked >= 9) {
                            fullPresentDays += 1;
                        }
                    }
                });

                // Short Duration Deduction = Total less hours (in whole month) / daily Working time (in hours)
                // This converts the total accumulated hour shortage into a day deduction.
                let shortDurationDeductionDays = 0;
                if (dailyWorkingTimeHours > 0) {
                     shortDurationDeductionDays = totalShortHours / dailyWorkingTimeHours;
                }

                return { totalHours, shortDurationDeductionDays, fullPresentDays };
            }

            // --- Dynamic Day Inputs Generation ---
            function generateDayInputs() {
                dailyHoursContainer.innerHTML = ''; // Clear existing inputs
                const daysInMonth = 31; // Always generate for 31 days to ensure summation is over 31 days.
                
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayWrapper = document.createElement('div');
                    dayWrapper.className = 'flex items-center space-x-2';
                    
                    const label = document.createElement('label');
                    label.className = 'text-sm text-gray-600 w-10';
                    label.textContent = `Day ${i}`;
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.step = '1';
                    input.className = 'input-field w-20 text-center p-1';
                    input.placeholder = 'Hours';
                    input.value = '0'; // Default to 0 hours
                    input.addEventListener('input', (e) => {
                        // Ensure input is a non-fractional number and round down if needed, as per requirement.
                        e.target.value = Math.floor(getNumberValue(e.target)); 
                        calculateSalary();
                    });
                    
                    dayWrapper.appendChild(label);
                    dayWrapper.appendChild(input);
                    dailyHoursContainer.appendChild(dayWrapper);
                }
            }
            
            // Note: The toggleDayInputsVisibility function is no longer needed since we calculate over 31 days.
            // We'll rely on the default visibility/hiding based on input value.

            // --- Event Listeners ---
            Object.values(inputs).forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('input', calculateSalary);
                    input.addEventListener('change', calculateSalary); // For select/dropdowns
                }
            });
            
            // --- Initial Setup ---
            generateDayInputs();
            calculateSalary(); // Initial calculation on page load
        });
    </script>
</body>
</html>
