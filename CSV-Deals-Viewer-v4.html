<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Deal Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        body { background: #f8f9fa; }
        .card-img-top { max-height: 140px; width: 100%; object-fit: contain; background: #f4f4f4; }
        .card-img-large { max-height: 140px; }
        .card-title { font-size: 1rem; min-height: 2.5em; font-weight: 500; white-space: normal; overflow: visible; text-overflow: unset; }
        .card { padding: 0.5rem; border-radius: 0.5rem; }
        .card-body { padding: 0.75rem 0.5rem 0.5rem 0.5rem; }
        .search-bar { max-width: 400px; margin: 1.5rem auto; }
        .filter-bar { max-width: 900px; margin: 0 auto 1.5rem; }
        .pagination-container { margin: 2rem 0 1rem; }
        .pagination-container ul.pagination { flex-wrap: wrap; }
        .pagination-container .page-link { min-width: 80px; text-align: center; }
        .pageJumpInput { max-width: 160px !important; min-width: 120px; display: inline-block; }
        .highlight-highest { color: #d9534f; font-weight: bold; }
        .highlight-lowest { color: #5cb85c; font-weight: bold; }
        .highlight-average { color: #0275d8; font-weight: bold; }
        .highlight-discount { color: #f0ad4e; font-weight: bold; }
        .highlight-price { color: #fff; background-color: #5cb85c; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .highlight-average-price-diff { color: #555; font-weight: bold; }
        .copy-btn { margin-left: 0.5rem; font-size: 0.95em; padding: 0.15rem 0.6rem; min-width: 40px; }
        .btn-buy-wide { min-width: 110px; }
        #hiddenCountDisplay { font-weight: 600; font-size: 0.9rem; }
    </style>
</head>

<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">CSV Deal Viewer</h1>
        <div class="text-center mb-4">
            <input type="file" id="csvFile" accept=".csv" class="form-control-file d-inline-block" style="max-width:300px;">
        </div>
        <div class="search-bar input-group mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by Name, Code, Store...">
            <div class="input-group-append">
                <button class="btn btn-primary" id="clearSearch" type="button">Clear</button>
            </div>
        </div>
        <div class="filter-bar row mb-3">
            <div class="col-md-3 mb-2"><input type="number" id="minPrice" class="form-control" placeholder="Min Price"></div>
            <div class="col-md-3 mb-2"><input type="number" id="maxPrice" class="form-control" placeholder="Max Price"></div>
            <div class="col-md-3 mb-2"><select id="storeSelect" class="form-control" style="height:auto;"><option value="">All Stores</option></select></div>
            <div class="col-md-3 mb-2 d-flex align-items-center">
                <label for="discountRange" class="mr-2 mb-0" style="white-space:nowrap;">Discount:</label>
                <input type="range" id="discountRange" min="0" max="100" step="1" value="0" class="custom-range" style="flex:1;">
                <span id="discountRangeValue" class="ml-2" style="min-width:48px;display:inline-block;">0%+</span>
            </div>
            <div class="col-md-3 mb-2"><select id="sellerNameSelect" class="form-control" style="height:auto;"><option value="">All Sellers</option></select></div>
            <div class="col-md-3 mb-2">
                <select id="sortSelect" class="form-control" style="height:auto;">
                    <option value="default">Sort: Default</option>
                    <option value="name-asc">Name ↑</option>
                    <option value="name-desc">Name ↓</option>
                    <option value="date-asc">Date ↑</option>
                    <option value="date-desc">Date ↓</option>
                    <option value="price-asc">Price ↑</option>
                    <option value="price-desc">Price ↓</option>
                    <option value="average-asc">Average ↑</option>
                    <option value="average-desc">Average ↓</option>
                    <option value="avg-price-diff-desc">Avg - Price ↓</option>
                    <option value="avg-price-diff-asc">Avg - Price ↑</option>
                    <option value="avg-price-diff-pct-desc">Avg - Price % ↓</option>
                    <option value="avg-price-diff-pct-asc">Avg - Price % ↑</option>
                </select>
            </div>
            <div class="col-md-6 mb-2">
                <input type="text" id="negativeKeywords" class="form-control" placeholder="Negative Keywords (comma separated)">
            </div>
            <div class="col-md-6 mb-2 d-flex align-items-center">
                <label for="dateMin" class="mr-2 mb-0" style="white-space:nowrap;">Date ≥</label>
                <input type="datetime-local" id="dateMin" class="form-control mr-2">
                <label for="dateMax" class="mr-2 mb-0" style="white-space:nowrap;">Date ≤</label>
                <input type="datetime-local" id="dateMax" class="form-control">
            </div>
            <div class="col-md-12 mb-2"><button class="btn btn-success btn-block" id="applyFilters">Apply Filters</button></div>
        </div>

        <div id="hiddenCountDisplay" class="text-center text-danger mb-3"></div>

        <nav id="paginationTop" class="pagination-container d-none"><ul class="pagination justify-content-center"></ul></nav>
        <div id="pageJumpTop" class="justify-content-center mb-4 d-none"></div>

        <div id="cardContainer" class="row"></div>

        <nav id="paginationBottom" class="pagination-container d-none mt-4"><ul class="pagination justify-content-center"></ul></nav>
        <div id="pageJumpBottom" class="justify-content-center mt-2 mb-5 d-none"></div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const pageSize = 60;
        let hiddenByNegativeCount = 0;

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(Boolean);
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = [];
                let cur = '', inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { values.push(cur); cur = ''; }
                    else cur += char;
                }
                values.push(cur);
                const obj = {};
                headers.forEach((h, i) => obj[h.trim()] = (values[i] || '').replace(/^"|"$/g, ''));
                return obj;
            });
        }

        function renderCardsPage(data, page) {
            const container = document.getElementById('cardContainer');
            const hiddenDisplay = document.getElementById('hiddenCountDisplay');
            hiddenDisplay.textContent = hiddenByNegativeCount > 0 ? `Items hidden by negative keywords: ${hiddenByNegativeCount}` : '';

            if (!data.length) {
                container.innerHTML = '<div class="text-center text-muted col-12">No results found.</div>';
                togglePaginationUI(false);
                return;
            }
            
            togglePaginationUI(true);
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, data.length);
            const pageData = data.slice(start, end);

            container.innerHTML = pageData.map((row, idx) => {
                let buyUrl = '';
                let storeName = row.Store;
                
                if (row.Store === '1') {
                    buyUrl = `https://www.amazon.in/pricehistory_app/dp/${row.Code}`;
                    storeName = 'Amazon';
                } else if (row.Store === '2') {
                    buyUrl = `https://www.flipkart.com/pricehistory_app-dealsspy/p/b?pid=${row.Code}`;
                    storeName = 'Flipkart';
                } else if (row.Store === '4') {
                    buyUrl = `https://www.amazon.com/pricehistory_app/dp/${row.Code}`;
                    storeName = 'Amazon_US';
                }

                let highest = parseInt(row.Highest) || '-';
                let lowest = parseInt(row.Lowest) || '-';
                let average = parseInt(row.Average) || '-';
                let price = parseInt(row.Price) || '-';
                let avgPriceDiff = (!isNaN(row.Average) && !isNaN(row.Price)) ? (parseInt(row.Average) - parseInt(row.Price)).toLocaleString('en-IN') : '-';
                let sellerName = row.SellerName || (row.SellerId ? 'Seller ' + row.SellerId : '-');
                let discount = row.Discount ? row.Discount + '%' : '-';

                return `
            <div class="col-12 col-sm-6 col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <img class="card-img-top card-img-large" src="${row.Image}" alt="${row.Name}" loading="lazy">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title mb-2" title="${row.Name}">${row.Name}</h5>
                        <div class="d-flex flex-wrap small text-muted mb-2">
                            <div class="mr-3"><span>${row.AddedOn}</span></div>
                            <div class="mr-3"><span>${sellerName}</span></div>
                            <div class="mr-3"><span>${storeName}</span></div>
                            <div class="mr-3"><span>${row.Code}</span></div>
                        </div>
                        <div class="d-flex flex-wrap small text-muted mb-2">
                            <div class="mr-3 highlight-highest">₹${highest}</div>
                            <div class="mr-3 highlight-average">₹${average}</div>
                            <div class="mr-3 highlight-lowest">₹${lowest}</div>
                            <div class="mr-3 highlight-average-price-diff">₹${avgPriceDiff}</div>
                        </div>
                        <div class="d-flex flex-wrap small text-muted mb-2">
                            <div class="mr-3 highlight-price"><strong>₹${price}</strong></div>
                            <div class="mr-3 highlight-discount">${discount}</div>
                        </div>
                        <div class="mt-auto d-flex align-items-center">
                            ${buyUrl ? `<a href="${buyUrl}" target="_blank" class="btn btn-sm btn-primary btn-buy-wide">Buy</a>` : ''}
                            <button class="btn btn-outline-secondary btn-sm copy-btn" data-url="${buyUrl}">Copy</button>
                        </div>
                    </div>
                </div>
            </div>`;
            }).join('');

            renderPagination('paginationTop', data.length, page);
            renderPagination('paginationBottom', data.length, page);
            renderJumpUI('pageJumpTop', data.length);
            renderJumpUI('pageJumpBottom', data.length);
            attachCopyEvents();
        }

        function togglePaginationUI(show) {
            const elements = ['paginationTop', 'paginationBottom', 'pageJumpTop', 'pageJumpBottom'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (show) { el.classList.remove('d-none'); el.classList.add('d-flex'); }
                else { el.classList.add('d-none'); el.classList.remove('d-flex'); }
            });
        }

        function renderPagination(containerId, total, page) {
            const nav = document.getElementById(containerId);
            const ul = nav.querySelector('ul');
            const pageCount = Math.ceil(total / pageSize);
            ul.innerHTML = '';
            const addPage = (p, text, active = false, disabled = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${text}</a>`;
                if (!disabled) li.onclick = (e) => { e.preventDefault(); currentPage = p; renderCardsPage(filteredData, p); window.scrollTo(0,0); };
                ul.appendChild(li);
            };
            addPage(page - 1, 'Previous', false, page === 1);
            for (let i = Math.max(1, page - 2); i <= Math.min(pageCount, page + 2); i++) addPage(i, i, i === page);
            addPage(page + 1, 'Next', false, page === pageCount);
        }

        function renderJumpUI(containerId, total) {
            const container = document.getElementById(containerId);
            const pageCount = Math.ceil(total / pageSize);
            container.innerHTML = `
                <div class="input-group" style="max-width:200px;">
                    <input type="number" class="form-control pageJumpInput" min="1" max="${pageCount}" placeholder="Go to page">
                    <div class="input-group-append"><button class="btn btn-outline-secondary jumpBtn" type="button">Go</button></div>
                </div>`;
            const input = container.querySelector('input');
            const btn = container.querySelector('button');
            const doJump = () => {
                const val = parseInt(input.value);
                if (val >= 1 && val <= pageCount) { currentPage = val; renderCardsPage(filteredData, val); window.scrollTo(0,0); }
            };
            btn.onclick = doJump;
            input.onkeyup = (e) => { if(e.key === 'Enter') doJump(); };
        }

        function getFilteredAndSearchedData() {
            let data = [...allData];
            const minP = parseFloat(document.getElementById('minPrice').value);
            const maxP = parseFloat(document.getElementById('maxPrice').value);
            const store = document.getElementById('storeSelect').value;
            const disc = parseInt(document.getElementById('discountRange').value) || 0;
            const seller = document.getElementById('sellerNameSelect').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const neg = document.getElementById('negativeKeywords').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
            const dateMin = document.getElementById('dateMin').value ? new Date(document.getElementById('dateMin').value) : null;
            const dateMax = document.getElementById('dateMax').value ? new Date(document.getElementById('dateMax').value) : null;

            if (!isNaN(minP)) data = data.filter(r => parseFloat(r.Price) >= minP);
            if (!isNaN(maxP)) data = data.filter(r => parseFloat(r.Price) <= maxP);
            if (store) data = data.filter(r => r.Store === store);
            if (seller) data = data.filter(r => (r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')) === seller);
            if (disc > 0) data = data.filter(r => parseInt(r.Discount) >= disc);
            if (dateMin) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) >= dateMin);
            if (dateMax) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) <= dateMax);
            if (search) data = data.filter(r => `${r.Name} ${r.Code}`.toLowerCase().includes(search));

            const preNegLength = data.length;
            if (neg.length) data = data.filter(r => !neg.some(w => `${r.Name} ${r.Code} ${r.Store}`.toLowerCase().includes(w)));
            hiddenByNegativeCount = preNegLength - data.length;

            const sortVal = document.getElementById('sortSelect').value;
            data.sort((a, b) => {
                const valA = parseFloat(a.Price) || 0;
                const valB = parseFloat(b.Price) || 0;
                const avgA = parseFloat(a.Average) || 0;
                const avgB = parseFloat(b.Average) || 0;

                switch (sortVal) {
                    case 'name-asc': return (a.Name || '').localeCompare(b.Name || '');
                    case 'name-desc': return (b.Name || '').localeCompare(a.Name || '');
                    case 'date-asc': return new Date(a.AddedOn || 0) - new Date(b.AddedOn || 0);
                    case 'date-desc': return new Date(b.AddedOn || 0) - new Date(a.AddedOn || 0);
                    case 'price-asc': return valA - valB;
                    case 'price-desc': return valB - valA;
                    case 'average-asc': return avgA - avgB;
                    case 'average-desc': return avgB - avgA;
                    case 'avg-price-diff-desc': return (avgB - valB) - (avgA - valA);
                    case 'avg-price-diff-asc': return (avgA - valA) - (avgB - valB);
                    case 'avg-price-diff-pct-desc':
                        const pctA = valA ? (avgA - valA) / valA : -Infinity;
                        const pctB = valB ? (avgB - valB) / valB : -Infinity;
                        return pctB - pctA;
                    case 'avg-price-diff-pct-asc':
                        const pctA_asc = valA ? (avgA - valA) / valA : Infinity;
                        const pctB_asc = valB ? (avgB - valB) / valB : Infinity;
                        return pctA_asc - pctB_asc;
                    default: return 0;
                }
            });

            return data;
        }

        function applyFilters() {
            filteredData = getFilteredAndSearchedData();
            currentPage = 1;
            renderCardsPage(filteredData, currentPage);
        }

        function attachCopyEvents() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.onclick = function () {
                    const url = this.getAttribute('data-url');
                    if (url) {
                        navigator.clipboard.writeText(url);
                        const oldText = this.textContent;
                        this.textContent = 'Copied!';
                        setTimeout(() => { this.textContent = oldText; }, 1200);
                    }
                };
            });
        }

        document.getElementById('csvFile').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                allData = parseCSV(evt.target.result);
                const storeMap = { '1': 'Amazon', '2': 'Flipkart', '4': 'Amazon_US' };
                const stores = Array.from(new Set(allData.map(r => r.Store))).filter(Boolean);
                document.getElementById('storeSelect').innerHTML = '<option value="">All Stores</option>' + 
                    stores.map(s => `<option value="${s}">${storeMap[s] || s}</option>`).join('');
                const sellers = Array.from(new Set(allData.map(r => r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')))).filter(Boolean).sort();
                document.getElementById('sellerNameSelect').innerHTML = '<option value="">All Sellers</option>' + 
                    sellers.map(s => `<option value="${s}">${s}</option>`).join('');
                applyFilters();
            };
            reader.readAsText(e.target.files[0]);
        };

        ['searchInput', 'negativeKeywords', 'storeSelect', 'sellerNameSelect', 'sortSelect', 'minPrice', 'maxPrice', 'dateMin', 'dateMax'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        document.getElementById('discountRange').oninput = function() {
            document.getElementById('discountRangeValue').textContent = this.value + '%+';
            applyFilters();
        };

        document.getElementById('clearSearch').onclick = () => { document.getElementById('searchInput').value = ''; applyFilters(); };
    </script>
</body>
</html>
