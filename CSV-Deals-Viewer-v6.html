<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Deal Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #9599a7 0%, #383739 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            padding-top: 80px; /* Space for fixed header */
        }

        /* --- Compact Header Styles --- */
        .controls-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            padding: 0.5rem 1rem;
        }

        .header-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .app-title { font-size: 1.1rem; font-weight: 700; color: #333; margin: 0; white-space: nowrap; }
        
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .btn-upload {
            border: 2px solid #e0e0e0;
            color: #555;
            background-color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }

        .search-container { flex-grow: 1; min-width: 200px; }
        .compact-input { height: 34px; font-size: 0.85rem; border-radius: 6px; }

        .btn-filter-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            height: 34px;
            padding: 0 15px;
            font-size: 0.85rem;
            border-radius: 6px;
            font-weight: 600;
        }
        .btn-filter-toggle:hover { color: white; opacity: 0.9; }

        /* --- Collapsible Filter Panel --- */
        #filterPanel {
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            margin: 0.5rem -1rem -0.5rem -1rem;
            padding: 1rem;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .filter-group-label { font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .filter-input { 
            font-size: 0.8rem; height: 30px; padding: 2px 8px; 
            border: 1px solid #ced4da; border-radius: 4px;
        }

        /* --- Existing Card Styles (Unchanged mostly) --- */
        .card { 
            border-radius: 8px; border: none; transition: all 0.3s ease; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); background: white;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.2); }
        .card-img-top { max-height: 100px; width: 100%; object-fit: contain; background: #ffffff; margin-top: 10px;}
        .card-body { padding: 0.5rem; }
        .card-title { font-size: 0.85rem; font-weight: 600; color: #333; height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 0.3rem;}
        
        .card-info { font-size: 0.7rem; color: #666; display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 5px; height: 22px; overflow: hidden;}
        .card-info span { background: #f0f0f0; padding: 1px 6px; border-radius: 3px; white-space: nowrap; }

        .price-section { padding: 4px 0; }
        .price-row { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 2px; }
        
        .highlight-highest { color: #d9534f; }
        .highlight-lowest { color: #5cb85c; }
        .highlight-average { color: #0275d8; }
        
        .main-price-row {
            display: flex; align-items: center; margin-top: 5px; padding-top: 5px; border-top: 1px solid #eee;
        }
        .current-price { font-size: 1.1rem; font-weight: 800; color: #333; }
        .discount-badge { 
            font-size: 0.75rem; font-weight: bold; color: white; 
            background: linear-gradient(135deg, #f0ad4e 0%, #ff8c42 100%);
            padding: 2px 8px; border-radius: 10px; margin-left: auto;
        }

        .action-buttons { display: flex; gap: 5px; margin-top: 8px; }
        .btn-buy { flex: 1; background: #667eea; color: white; border: none; font-size: 0.75rem; padding: 4px; border-radius: 4px; }
        .btn-copy { background: white; border: 1px solid #ddd; color: #555; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; width: 50px;}
        .btn-buy:hover { background: #5a6fd6; color: white; text-decoration: none;}
        .btn-copy:hover { background: #f8f9fa; }

        #hiddenCountDisplay { 
            position: fixed; bottom: 20px; right: 20px; z-index: 900;
            background: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem;
        }
        
        .pagination-container { display: flex; justify-content: center; gap: 5px; margin: 20px 0; }
        .page-btn { 
            background: white; border: 1px solid #ddd; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.9rem;
        }
        .page-btn.active { background: #667eea; color: white; border-color: #667eea; }

        @media (max-width: 768px) {
            .controls-header { padding: 0.5rem; }
            .app-title { display: none; } /* Hide title on mobile to save space */
            .header-row { gap: 5px; }
            .search-container { order: 3; width: 100%; min-width: 100%; margin-top: 5px;}
            .filter-col { margin-bottom: 10px; }
            body { padding-top: 110px; }
        }
    </style>
</head>

<body>

    <div class="controls-header">
        <div class="header-row">
            <h1 class="app-title"><i class="fas fa-tags text-primary"></i> Deal Viewer</h1>
            
            <div class="upload-btn-wrapper">
                <button class="btn-upload"><i class="fas fa-file-upload"></i> Upload CSV</button>
                <input type="file" id="csvFile" accept=".csv">
            </div>

            <div class="search-container">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control compact-input" placeholder="Search name, code...">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary compact-input" id="clearSearch" type="button" style="padding: 0 10px;">&times;</button>
                    </div>
                </div>
            </div>

            <select id="sortSelect" class="form-control compact-input" style="width: auto; max-width: 160px;">
                <option value="default">Sort: Default</option>
                <option value="discount-desc">Discount (High-Low)</option>
                <option value="discount-asc">Discount (Low-High)</option>
                <option value="price-asc">Price (Low-High)</option>
                <option value="price-desc">Price (High-Low)</option>
                <option value="avg-price-diff-desc">Best Value (Avg-Price)</option>
                <option value="date-desc">Date (Newest)</option>
                <option value="name-asc">Name (A-Z)</option>
            </select>

            <button class="btn btn-filter-toggle" type="button" data-toggle="collapse" data-target="#filterPanel">
                <i class="fas fa-filter"></i> Options
            </button>
        </div>

        <div id="filterPanel" class="collapse">
            <div class="row">
                <div class="col-6 col-md-2 filter-col">
                    <label class="filter-group-label">Price (₹)</label>
                    <div class="d-flex gap-1">
                        <input type="number" id="minPrice" class="form-control filter-input" placeholder="Min">
                        <input type="number" id="maxPrice" class="form-control filter-input" placeholder="Max">
                    </div>
                </div>

                <div class="col-6 col-md-2 filter-col">
                    <label class="filter-group-label">MRP (₹)</label>
                    <div class="d-flex gap-1">
                        <input type="number" id="minMRP" class="form-control filter-input" placeholder="Min">
                        <input type="number" id="maxMRP" class="form-control filter-input" placeholder="Max">
                    </div>
                </div>

                <div class="col-6 col-md-2 filter-col">
                    <label class="filter-group-label">Discount (%)</label>
                    <div class="d-flex gap-1">
                        <input type="number" id="minDiscount" class="form-control filter-input" placeholder="Min %">
                        <input type="number" id="maxDiscount" class="form-control filter-input" placeholder="Max %">
                    </div>
                </div>

                <div class="col-6 col-md-2 filter-col">
                    <label class="filter-group-label">Store</label>
                    <select id="storeSelect" class="form-control filter-input">
                        <option value="">All Stores</option>
                    </select>
                </div>
                 <div class="col-6 col-md-2 filter-col">
                    <label class="filter-group-label">Seller</label>
                    <select id="sellerNameSelect" class="form-control filter-input">
                        <option value="">All Sellers</option>
                    </select>
                </div>

                <div class="col-12 col-md-2 filter-col">
                    <label class="filter-group-label">Negative Keywords</label>
                    <input type="text" id="negativeKeywords" class="form-control filter-input" placeholder="exclude1, exclude2">
                </div>
            </div>
            
            <div class="row mt-2">
                 <div class="col-12 col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="filter-group-label mr-2">Date:</span>
                        <input type="date" id="dateMin" class="form-control filter-input mr-1" style="width: auto;">
                        <span class="small">-</span>
                        <input type="date" id="dateMax" class="form-control filter-input ml-1" style="width: auto;">
                    </div>
                 </div>
                 <div class="col-12 col-md-8 text-right">
                    <button class="btn btn-sm btn-success px-4" id="applyFilters" style="height: 30px; line-height: 1;">Apply Filters</button>
                 </div>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 px-md-5">
        
        <div id="hiddenCountDisplay" style="display:none;"></div>

        <div id="paginationTop" class="pagination-container d-none"></div>

        <div id="cardContainer" class="row">
            <div class="col-12 text-center text-white mt-5">
                <h3><i class="fas fa-arrow-up"></i> Upload a CSV to begin</h3>
            </div>
        </div>

        <div id="paginationBottom" class="pagination-container d-none"></div>
        
        <div id="pageJumpSection" class="text-center mb-5 d-none">
            <input type="number" id="jumpInput" placeholder="#" style="width: 50px; text-align: center; border-radius: 4px; border: 1px solid #ccc;">
            <button id="jumpBtn" class="btn btn-sm btn-light">Go</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const pageSize = 60;
        let hiddenByNegativeCount = 0;

        function optimizeImageUrl(url) {
            if(!url) return '';
            url = url.replace(/flixcart\.com\/image\/\d+\/\d+\//g, 'flixcart.com/image/250/250/');
            url = url.replace(/(\/images\/I\/[^.]+)\.jpg/g, '$1._SS250_FMwebp_.jpg');
            return url;
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(Boolean);
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = [];
                let cur = '', inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { values.push(cur); cur = ''; }
                    else cur += char;
                }
                values.push(cur);
                const obj = {};
                headers.forEach((h, i) => obj[h.trim()] = (values[i] || '').replace(/^"|"$/g, ''));
                return obj;
            });
        }

        function renderCardsPage(data, page) {
            const container = document.getElementById('cardContainer');
            const hiddenDisplay = document.getElementById('hiddenCountDisplay');
            
            if(hiddenByNegativeCount > 0) {
                hiddenDisplay.style.display = 'block';
                hiddenDisplay.textContent = `Hidden by keywords: ${hiddenByNegativeCount}`;
            } else {
                hiddenDisplay.style.display = 'none';
            }

            if (!data.length) {
                container.innerHTML = '<div class="text-center text-white col-12 mt-4">No results found matching your filters.</div>';
                togglePaginationUI(false);
                return;
            }
            
            togglePaginationUI(true);
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, data.length);
            const pageData = data.slice(start, end);

            container.innerHTML = pageData.map((row, idx) => {
                let buyUrl = '';
                let storeName = row.Store;
                
                if (row.Store === '1') { buyUrl = `https://www.amazon.in/pricehistory_app/dp/${row.Code}`; storeName = 'Amazon'; } 
                else if (row.Store === '2') { buyUrl = `https://www.flipkart.com/pricehistory_app-dealsspy/p/b?pid=${row.Code}`; storeName = 'Flipkart'; } 
                else if (row.Store === '4') { buyUrl = `https://www.amazon.com/pricehistory_app/dp/${row.Code}`; storeName = 'Amazon US'; }

                let highest = parseInt(row.Highest) || 0;
                let lowest = parseInt(row.Lowest) || 0;
                let average = parseInt(row.Average) || 0;
                let price = parseInt(row.Price) || 0;
                let mrp = parseInt(row.MRP) || 0;
                let sellerName = row.SellerName || (row.SellerId ? 'Seller ' + row.SellerId : 'Unknown');
                let discount = parseFloat(row.Discount) || 0;
                let displayDiscount = discount > 0 ? `${discount}%` : '';

                return `
            <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3 px-2">
                <div class="card h-100">
                    <img class="card-img-top" src="${optimizeImageUrl(row.Image)}" alt="img" loading="lazy">
                    <div class="card-body d-flex flex-column">
                        <div class="card-title" title="${row.Name}">${row.Name}</div>
                        <div class="card-info">
                            <span title="Store">${storeName}</span>
                            <span title="Seller">${sellerName.substring(0,15)}</span>
                        </div>
                        
                        <div class="price-section flex-grow-1">
                            <div class="price-row">
                                <span class="text-muted">High: ₹${highest}</span>
                                <span class="text-muted">Low: ₹${lowest}</span>
                            </div>
                            <div class="price-row">
                                <span class="text-muted">Avg: ₹${average}</span>
                                <span class="text-muted">MRP: ₹${mrp}</span>
                            </div>
                            <div class="main-price-row">
                                <span class="current-price">₹${price}</span>
                                ${displayDiscount ? `<span class="discount-badge">${displayDiscount}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            ${buyUrl ? `<a href="${buyUrl}" target="_blank" class="btn btn-buy">Buy</a>` : ''}
                            <button class="btn btn-copy" data-url="${buyUrl}">Copy</button>
                        </div>
                    </div>
                </div>
            </div>`;
            }).join('');

            updatePagination(data.length, page);
            attachCopyEvents();
        }

        function togglePaginationUI(show) {
            const display = show ? 'flex' : 'none';
            document.getElementById('paginationTop').style.display = display;
            document.getElementById('paginationBottom').style.display = display;
            document.getElementById('pageJumpSection').classList.toggle('d-none', !show);
        }

        function updatePagination(total, page) {
            const pageCount = Math.ceil(total / pageSize);
            const generateHTML = () => {
                let html = '';
                if(page > 1) html += `<div class="page-btn" onclick="goToPage(${page-1})">«</div>`;
                
                let start = Math.max(1, page - 2);
                let end = Math.min(pageCount, page + 2);
                
                for(let i=start; i<=end; i++) {
                    html += `<div class="page-btn ${i===page?'active':''}" onclick="goToPage(${i})">${i}</div>`;
                }
                
                if(page < pageCount) html += `<div class="page-btn" onclick="goToPage(${page+1})">»</div>`;
                return html;
            };
            
            document.getElementById('paginationTop').innerHTML = generateHTML();
            document.getElementById('paginationBottom').innerHTML = generateHTML();
        }

        window.goToPage = function(p) {
            currentPage = p;
            renderCardsPage(filteredData, p);
            window.scrollTo(0,0);
        }

        function getFilteredAndSearchedData() {
            let data = [...allData];
            
            // Get Values
            const minP = parseFloat(document.getElementById('minPrice').value);
            const maxP = parseFloat(document.getElementById('maxPrice').value);
            const minM = parseFloat(document.getElementById('minMRP').value);
            const maxM = parseFloat(document.getElementById('maxMRP').value);
            const minD = parseFloat(document.getElementById('minDiscount').value); // NEW
            const maxD = parseFloat(document.getElementById('maxDiscount').value); // NEW
            
            const store = document.getElementById('storeSelect').value;
            const seller = document.getElementById('sellerNameSelect').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const neg = document.getElementById('negativeKeywords').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
            const dateMin = document.getElementById('dateMin').value ? new Date(document.getElementById('dateMin').value) : null;
            const dateMax = document.getElementById('dateMax').value ? new Date(document.getElementById('dateMax').value) : null;

            // Apply Filters
            if (!isNaN(minP)) data = data.filter(r => parseFloat(r.Price) >= minP);
            if (!isNaN(maxP)) data = data.filter(r => parseFloat(r.Price) <= maxP);
            if (!isNaN(minM)) data = data.filter(r => parseFloat(r.MRP) >= minM);
            if (!isNaN(maxM)) data = data.filter(r => parseFloat(r.MRP) <= maxM);
            if (!isNaN(minD)) data = data.filter(r => parseFloat(r.Discount) >= minD); // NEW
            if (!isNaN(maxD)) data = data.filter(r => parseFloat(r.Discount) <= maxD); // NEW
            
            if (store) data = data.filter(r => r.Store === store);
            if (seller) data = data.filter(r => (r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')) === seller);
            
            if (dateMin) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) >= dateMin);
            if (dateMax) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) <= dateMax);
            
            if (search) data = data.filter(r => `${r.Name} ${r.Code}`.toLowerCase().includes(search));

            const preNegLength = data.length;
            if (neg.length) data = data.filter(r => !neg.some(w => `${r.Name} ${r.Code} ${r.Store}`.toLowerCase().includes(w)));
            hiddenByNegativeCount = preNegLength - data.length;

            // Sorting
            const sortVal = document.getElementById('sortSelect').value;
            data.sort((a, b) => {
                const valA = parseFloat(a.Price) || 0;
                const valB = parseFloat(b.Price) || 0;
                const avgA = parseFloat(a.Average) || 0;
                const avgB = parseFloat(b.Average) || 0;
                const discA = parseFloat(a.Discount) || 0;
                const discB = parseFloat(b.Discount) || 0;

                switch (sortVal) {
                    case 'discount-desc': return discB - discA; // NEW
                    case 'discount-asc': return discA - discB; // NEW
                    case 'name-asc': return (a.Name || '').localeCompare(b.Name || '');
                    case 'date-desc': return new Date(b.AddedOn || 0) - new Date(a.AddedOn || 0);
                    case 'price-asc': return valA - valB;
                    case 'price-desc': return valB - valA;
                    case 'avg-price-diff-desc': return (avgB - valB) - (avgA - valA);
                    default: return 0;
                }
            });

            return data;
        }

        function applyFilters() {
            filteredData = getFilteredAndSearchedData();
            currentPage = 1;
            renderCardsPage(filteredData, currentPage);
        }

        function attachCopyEvents() {
            document.querySelectorAll('.btn-copy').forEach(btn => {
                btn.onclick = function () {
                    const url = this.getAttribute('data-url');
                    if (url) {
                        navigator.clipboard.writeText(url);
                        const oldText = this.textContent;
                        this.textContent = '✓';
                        setTimeout(() => { this.textContent = oldText; }, 1200);
                    }
                };
            });
        }

        // Event Listeners
        document.getElementById('csvFile').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                allData = parseCSV(evt.target.result);
                const storeMap = { '1': 'Amazon', '2': 'Flipkart', '4': 'Amazon US' };
                
                // Populate Stores
                const stores = Array.from(new Set(allData.map(r => r.Store))).filter(Boolean);
                document.getElementById('storeSelect').innerHTML = '<option value="">All Stores</option>' + 
                    stores.map(s => `<option value="${s}">${storeMap[s] || s}</option>`).join('');
                
                // Populate Sellers
                const sellers = Array.from(new Set(allData.map(r => r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')))).filter(Boolean).sort();
                document.getElementById('sellerNameSelect').innerHTML = '<option value="">All Sellers</option>' + 
                    sellers.map(s => `<option value="${s}">${s}</option>`).join('');
                
                applyFilters();
                // Close filter panel if open on upload
                $('#filterPanel').collapse('hide');
            };
            reader.readAsText(e.target.files[0]);
        };

        const filterInputs = ['searchInput', 'negativeKeywords', 'storeSelect', 'sellerNameSelect', 
                            'sortSelect', 'minPrice', 'maxPrice', 'minMRP', 'maxMRP', 
                            'minDiscount', 'maxDiscount', 'dateMin', 'dateMax'];
        
        filterInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        document.getElementById('clearSearch').onclick = () => { 
            document.getElementById('searchInput').value = ''; 
            applyFilters(); 
        };

        // Jump Button Logic
        document.getElementById('jumpBtn').onclick = () => {
             const val = parseInt(document.getElementById('jumpInput').value);
             const maxPage = Math.ceil(filteredData.length / pageSize);
             if(val > 0 && val <= maxPage) goToPage(val);
        }
    </script>
</body>
</html>
