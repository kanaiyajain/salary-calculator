<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Deal Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        /* --- ORIGINAL STYLING RESTORED --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #9599a7 0%, #383739 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            padding-bottom: 50px;
        }
        h1 { color: #333; font-weight: 700; font-size: 1.5rem; margin: 0; white-space: nowrap; }
        
        /* Compact Control Panel */
        .control-panel {
            background: white;
            padding: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid #ddd;
        }

        .filter-label { font-size: 0.7rem; font-weight: 700; color: #555; margin-bottom: 2px; display: block; }
        
        .form-control-sm { 
            height: 30px; 
            font-size: 0.8rem; 
            border: 1px solid #ced4da;
        }
        .form-control-sm:focus { border-color: #667eea; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1); }

        /* Original Buttons */
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: 600; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        
        .btn-success { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none; font-weight: 600; font-size: 0.8rem; height: 30px; line-height: 1;
        }
        .btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4); }

        /* Original Card Styling */
        .card { 
            padding: 0.4rem; 
            border-radius: 8px; 
            border: none;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            background: white;
            height: 100%;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.2); }
        
        .card-img-top { 
            max-height: 120px; 
            width: 100%; 
            object-fit: contain; 
            background: #ffffff;
            border-radius: 6px;
            margin-bottom: 5px;
        }
        
        .card-body { padding: 0.2rem; display: flex; flex-direction: column; }
        
        .card-title { 
            font-size: 0.85rem; 
            min-height: 2.4em; 
            font-weight: 600; 
            color: #333;
            line-height: 1.2;
            margin-bottom: 0.3rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-info { 
            font-size: 0.75rem; color: #666; margin-bottom: 0.4rem;
            display: flex; flex-wrap: wrap; gap: 0.3rem;
        }
        .card-info span { background: #f0f0f0; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;}
        
        .price-section { 
            background: #fafafa; padding: 0.25rem; border-radius: 6px; margin: 0.3rem 0; flex-grow: 1;
        }
        
        .price-row { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 2px; }
        
        /* Original Highlight Colors */
        .highlight-highest { color: #d9534f; font-weight: bold; }
        .highlight-lowest { color: #5cb85c; font-weight: bold; }
        .highlight-average { color: #0275d8; font-weight: bold; }
        .highlight-discount { 
            color: #fff; 
            background: linear-gradient(135deg, #f0ad4e 0%, #ff8c42 100%);
            padding: 0.1rem 0.5rem; border-radius: 4px; font-weight: bold; font-size: 0.75rem;
        }
        .highlight-price { 
            color: #dbdada; 
            background: linear-gradient(135deg, #070914 0%, #232323 100%);
            padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: bold;
        }
        .highlight-mrp { color: #888; text-decoration: line-through; }

        .action-buttons { display: flex; gap: 0.3rem; margin-top: 0.4rem; }
        
        .btn-buy-wide { 
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; color: white; font-weight: 600; border-radius: 6px;
            padding: 0.2rem 0.4rem; font-size: 0.75rem;
        }
        .btn-buy-wide:hover { transform: translateY(-1px); color: white; text-decoration: none; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3); }
        
        .copy-btn { 
            background: white; border: 1px solid #e0e0e0; border-radius: 6px;
            color: #667eea; font-weight: 600; font-size: 0.75rem; padding: 0.2rem 0.5rem;
            min-width: 50px;
        }
        .copy-btn:hover { background: #f0f0f0; border-color: #667eea; }

        /* Pagination */
        .pagination-container { margin: 1rem 0; display: flex; justify-content: center; }
        .page-link { color: #667eea; border-radius: 4px; margin: 0 2px; font-weight: 600; }
        .page-item.active .page-link { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: transparent; }
        
        #hiddenCountDisplay { 
            font-weight: 700; font-size: 0.85rem; background: #fff3cd; color: #856404;
            padding: 0.4rem 1rem; border-radius: 6px; display: inline-block; margin-bottom: 1rem;
        }

        /* Custom narrow columns for the top bar */
        .col-compact { padding-left: 5px; padding-right: 5px; }
        .row-compact { margin-left: -5px; margin-right: -5px; }
        
        /* Force Boxy Layout Center */
        .main-container { max-width: 1140px; margin: 0 auto; padding: 0 15px; }
    </style>
</head>

<body>

    <div class="control-panel">
        <div class="main-container">
            <div class="row row-compact align-items-center mb-2">
                <div class="col-auto col-compact">
                    <h1>ðŸŽ¯ Deals</h1>
                </div>
                <div class="col-auto col-compact">
                    <input type="file" id="csvFile" accept=".csv" class="form-control-file" style="font-size: 0.8rem; width: 180px;">
                </div>
                <div class="col col-compact">
                    <div class="input-group input-group-sm">
                        <input type="text" id="searchInput" class="form-control" placeholder="ðŸ” Search Name, Code...">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" id="clearSearch" type="button">X</button>
                        </div>
                    </div>
                </div>
                <div class="col-auto col-compact">
                    <button class="btn btn-success" id="applyFilters">âœ“ Apply</button>
                </div>
            </div>

            <div class="row row-compact mb-2">
                <div class="col-6 col-md-2 col-compact">
                    <span class="filter-label">Price â‚¹</span>
                    <div class="d-flex">
                        <input type="number" id="minPrice" class="form-control form-control-sm mr-1" placeholder="Min">
                        <input type="number" id="maxPrice" class="form-control form-control-sm" placeholder="Max">
                    </div>
                </div>
                <div class="col-6 col-md-2 col-compact">
                    <span class="filter-label">MRP â‚¹</span>
                    <div class="d-flex">
                        <input type="number" id="minMRP" class="form-control form-control-sm mr-1" placeholder="Min">
                        <input type="number" id="maxMRP" class="form-control form-control-sm" placeholder="Max">
                    </div>
                </div>
                <div class="col-6 col-md-2 col-compact">
                    <span class="filter-label">Discount %</span>
                    <div class="d-flex">
                        <input type="number" id="minDiscount" class="form-control form-control-sm mr-1" placeholder="Min">
                        <input type="number" id="maxDiscount" class="form-control form-control-sm" placeholder="Max">
                    </div>
                </div>
                 <div class="col-6 col-md-2 col-compact">
                    <span class="filter-label">Sort By</span>
                    <select id="sortSelect" class="form-control form-control-sm">
                        <option value="default">Default</option>
                        <option value="discount-desc">Discount (High)</option>
                        <option value="discount-asc">Discount (Low)</option>
                        <option value="price-asc">Price (Low)</option>
                        <option value="price-desc">Price (High)</option>
                        <option value="avg-price-diff-pct-asc">Price vs Avg % (Low)</option>
                        <option value="avg-price-diff-pct-desc">Price vs Avg % (High)</option>
                        <option value="avg-price-diff-desc">Best Value (Abs)</option>
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="date-desc">Date (New)</option>
                    </select>
                </div>
                 <div class="col-12 col-md-4 col-compact">
                    <span class="filter-label">Negative Keywords</span>
                    <input type="text" id="negativeKeywords" class="form-control form-control-sm" placeholder="Ex: refurbished, case, cover">
                </div>
            </div>

            <div class="row row-compact">
                <div class="col-4 col-md-2 col-compact">
                    <span class="filter-label">Store</span>
                    <select id="storeSelect" class="form-control form-control-sm"><option value="">All</option></select>
                </div>
                <div class="col-8 col-md-3 col-compact">
                    <span class="filter-label">Seller</span>
                    <div class="d-flex">
                        <input type="text" id="sellerSearchInput" class="form-control form-control-sm mr-1" placeholder="Find..." style="width: 35%;">
                        <select id="sellerNameSelect" class="form-control form-control-sm" style="width: 65%;"><option value="">All</option></select>
                    </div>
                </div>
                <div class="col-12 col-md-3 col-compact">
                     <span class="filter-label">Date Range</span>
                     <div class="d-flex align-items-center">
                        <input type="date" id="dateMin" class="form-control form-control-sm p-0">
                        <span class="mx-1 text-muted">-</span>
                        <input type="date" id="dateMax" class="form-control form-control-sm p-0">
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        
        <div id="hiddenCountDisplay" class="text-center" style="display:none;"></div>

        <nav id="paginationTop" class="pagination-container d-none"><ul class="pagination pagination-sm justify-content-center m-0"></ul></nav>
        
        <div id="cardContainer" class="row"></div>

        <nav id="paginationBottom" class="pagination-container d-none mt-4"><ul class="pagination pagination-sm justify-content-center"></ul></nav>
        
        <div id="pageJumpBottom" class="d-flex justify-content-center mt-2 mb-5 d-none">
            <div class="input-group input-group-sm" style="width: 150px;">
                <input type="number" class="form-control" id="jumpInput" placeholder="Page #">
                <div class="input-group-append">
                    <button class="btn btn-secondary" id="jumpBtn">Go</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const pageSize = 60;
        let hiddenByNegativeCount = 0;

        function optimizeImageUrl(url) {
            if(!url) return '';
            url = url.replace(/flixcart\.com\/image\/\d+\/\d+\//g, 'flixcart.com/image/250/250/');
            url = url.replace(/(\/images\/I\/[^.]+)\.jpg/g, '$1._SS250_FMwebp_.jpg');
            return url;
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(Boolean);
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = [];
                let cur = '', inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { values.push(cur); cur = ''; }
                    else cur += char;
                }
                values.push(cur);
                const obj = {};
                headers.forEach((h, i) => obj[h.trim()] = (values[i] || '').replace(/^"|"$/g, ''));
                return obj;
            });
        }

        function renderCardsPage(data, page) {
            const container = document.getElementById('cardContainer');
            const hiddenDisplay = document.getElementById('hiddenCountDisplay');
            
            if(hiddenByNegativeCount > 0) {
                hiddenDisplay.style.display = 'inline-block';
                hiddenDisplay.textContent = `Hidden by negative keywords: ${hiddenByNegativeCount}`;
            } else {
                hiddenDisplay.style.display = 'none';
            }

            if (!data.length) {
                container.innerHTML = '<div class="text-center text-white col-12 mt-5"><h4>No results found.</h4></div>';
                togglePaginationUI(false);
                return;
            }
            
            togglePaginationUI(true);
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, data.length);
            const pageData = data.slice(start, end);

            container.innerHTML = pageData.map((row) => {
                let buyUrl = '';
                let storeName = row.Store;
                
                if (row.Store === '1') { buyUrl = `https://www.amazon.in/pricehistory_app/dp/${row.Code}`; storeName = 'Amazon'; }
                else if (row.Store === '2') { buyUrl = `https://www.flipkart.com/pricehistory_app-dealsspy/p/b?pid=${row.Code}`; storeName = 'Flipkart'; }
                else if (row.Store === '4') { buyUrl = `https://www.amazon.com/pricehistory_app/dp/${row.Code}`; storeName = 'Amazon US'; }

                let highest = parseInt(row.Highest) || 0;
                let lowest = parseInt(row.Lowest) || 0;
                let average = parseInt(row.Average) || 0;
                let price = parseInt(row.Price) || 0;
                let mrp = parseInt(row.MRP) || 0;
                let sellerName = row.SellerName || (row.SellerId ? 'Seller ' + row.SellerId : '-');
                let discount = parseFloat(row.Discount) || 0;
                let discDisplay = discount > 0 ? discount + '%' : '';

                return `
            <div class="col-6 col-sm-6 col-lg-3 mb-3 px-2">
                <div class="card h-100">
                    <img class="card-img-top" src="${optimizeImageUrl(row.Image)}" alt="Img" loading="lazy">
                    <div class="card-body">
                        <h5 class="card-title" title="${row.Name}">${row.Name}</h5>
                        <div class="card-info">
                            <span title="Store">${storeName}</span>
                            <span title="Seller">${sellerName.substring(0,12)}</span>
                            <span title="Date">${row.AddedOn ? row.AddedOn.split(' ')[0] : ''}</span>
                        </div>
                        <div class="price-section">
                            <div class="price-row">
                                <span class="text-muted">High: <span class="highlight-highest">â‚¹${highest}</span></span>
                                <span class="text-muted">Low: <span class="highlight-lowest">â‚¹${lowest}</span></span>
                            </div>
                            <div class="price-row">
                                <span class="text-muted">Avg: <span class="highlight-average">â‚¹${average}</span></span>
                                <span class="highlight-mrp">MRP: â‚¹${mrp}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2 pt-1 border-top">
                                <span class="highlight-price" style="font-size: 1.1rem;">â‚¹${price}</span>
                                ${discDisplay ? `<span class="highlight-discount">${discDisplay} OFF</span>` : ''}
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${buyUrl ? `<a href="${buyUrl}" target="_blank" class="btn btn-buy-wide">ðŸ›’ Buy</a>` : ''}
                            <button class="btn copy-btn" data-url="${buyUrl}">ðŸ“‹</button>
                        </div>
                    </div>
                </div>
            </div>`;
            }).join('');

            renderPagination('paginationTop', data.length, page);
            renderPagination('paginationBottom', data.length, page);
            attachCopyEvents();
        }

        function togglePaginationUI(show) {
            const els = ['paginationTop', 'paginationBottom', 'pageJumpBottom'];
            els.forEach(id => {
                const el = document.getElementById(id);
                if(show) { el.classList.remove('d-none'); el.classList.add('d-flex'); }
                else { el.classList.add('d-none'); el.classList.remove('d-flex'); }
            });
        }

        function renderPagination(containerId, total, page) {
            const nav = document.getElementById(containerId);
            const ul = nav.querySelector('ul');
            const pageCount = Math.ceil(total / pageSize);
            ul.innerHTML = '';
            
            const add = (p, txt, active=false, disabled=false) => {
                const li = document.createElement('li');
                li.className = `page-item ${active?'active':''} ${disabled?'disabled':''}`;
                li.innerHTML = `<a class="page-link" href="#">${txt}</a>`;
                if(!disabled && !active) li.onclick = (e) => { e.preventDefault(); currentPage = p; renderCardsPage(filteredData, p); window.scrollTo(0,0); };
                ul.appendChild(li);
            };

            if(page > 1) add(page-1, 'Â«');
            let start = Math.max(1, page - 2);
            let end = Math.min(pageCount, page + 2);
            for(let i=start; i<=end; i++) add(i, i, i===page);
            if(page < pageCount) add(page+1, 'Â»');
        }

        function getFilteredAndSearchedData() {
            let data = [...allData];
            
            // Read Inputs
            const minP = parseFloat(document.getElementById('minPrice').value);
            const maxP = parseFloat(document.getElementById('maxPrice').value);
            const minM = parseFloat(document.getElementById('minMRP').value);
            const maxM = parseFloat(document.getElementById('maxMRP').value);
            const minD = parseFloat(document.getElementById('minDiscount').value);
            const maxD = parseFloat(document.getElementById('maxDiscount').value);
            const store = document.getElementById('storeSelect').value;
            const seller = document.getElementById('sellerNameSelect').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const neg = document.getElementById('negativeKeywords').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
            const dateMin = document.getElementById('dateMin').value ? new Date(document.getElementById('dateMin').value) : null;
            const dateMax = document.getElementById('dateMax').value ? new Date(document.getElementById('dateMax').value) : null;

            // Apply Filters
            if (!isNaN(minP)) data = data.filter(r => parseFloat(r.Price) >= minP);
            if (!isNaN(maxP)) data = data.filter(r => parseFloat(r.Price) <= maxP);
            if (!isNaN(minM)) data = data.filter(r => parseFloat(r.MRP) >= minM);
            if (!isNaN(maxM)) data = data.filter(r => parseFloat(r.MRP) <= maxM);
            if (!isNaN(minD)) data = data.filter(r => parseFloat(r.Discount) >= minD);
            if (!isNaN(maxD)) data = data.filter(r => parseFloat(r.Discount) <= maxD);

            if (store) data = data.filter(r => r.Store === store);
            if (seller) data = data.filter(r => (r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')) === seller);
            if (dateMin) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) >= dateMin);
            if (dateMax) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) <= dateMax);
            
            if (search) data = data.filter(r => `${r.Name} ${r.Code}`.toLowerCase().includes(search));

            const preNegLength = data.length;
            if (neg.length) data = data.filter(r => !neg.some(w => `${r.Name} ${r.Code} ${r.Store}`.toLowerCase().includes(w)));
            hiddenByNegativeCount = preNegLength - data.length;

            // Sorting
            const sortVal = document.getElementById('sortSelect').value;
            data.sort((a, b) => {
                const pA = parseFloat(a.Price)||0, pB = parseFloat(b.Price)||0;
                const dA = parseFloat(a.Discount)||0, dB = parseFloat(b.Discount)||0;
                const avgA = parseFloat(a.Average)||0, avgB = parseFloat(b.Average)||0;
                
                switch (sortVal) {
                    case 'discount-desc': return dB - dA;
                    case 'discount-asc': return dA - dB;
                    case 'price-asc': return pA - pB;
                    case 'price-desc': return pB - pA;
                    case 'name-asc': return (a.Name||'').localeCompare(b.Name||'');
                    case 'date-desc': return new Date(b.AddedOn||0) - new Date(a.AddedOn||0);
                    case 'avg-price-diff-desc': 
                        return ((parseFloat(b.Average)||0) - pB) - ((parseFloat(a.Average)||0) - pA);
                    
                    // NEW SORT: Percentage Difference (Low to High)
                    // (Price - Average) / Average
                    case 'avg-price-diff-pct-asc': {
                        let pctA = avgA ? ((pA - avgA) / avgA) : Infinity;
                        let pctB = avgB ? ((pB - avgB) / avgB) : Infinity;
                        return pctA - pctB;
                    }
                    // NEW SORT: Percentage Difference (High to Low)
                    case 'avg-price-diff-pct-desc': {
                        let pctA = avgA ? ((pA - avgA) / avgA) : -Infinity;
                        let pctB = avgB ? ((pB - avgB) / avgB) : -Infinity;
                        return pctB - pctA;
                    }

                    default: return 0;
                }
            });

            return data;
        }

        function applyFilters() {
            filteredData = getFilteredAndSearchedData();
            currentPage = 1;
            renderCardsPage(filteredData, currentPage);
        }

        function attachCopyEvents() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.onclick = function () {
                    const url = this.getAttribute('data-url');
                    if (url) {
                        navigator.clipboard.writeText(url);
                        const old = this.textContent;
                        this.textContent = 'âœ“';
                        setTimeout(() => { this.textContent = old; }, 1000);
                    }
                };
            });
        }

        document.getElementById('csvFile').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                allData = parseCSV(evt.target.result);
                // Populate Stores
                const storeMap = { '1': 'Amazon', '2': 'Flipkart', '4': 'Amazon US' };
                const stores = Array.from(new Set(allData.map(r => r.Store))).filter(Boolean);
                document.getElementById('storeSelect').innerHTML = '<option value="">All</option>' + 
                    stores.map(s => `<option value="${s}">${storeMap[s] || s}</option>`).join('');
                
                // Populate Sellers
                const sellers = Array.from(new Set(allData.map(r => r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')))).filter(Boolean).sort();
                document.getElementById('sellerNameSelect').innerHTML = '<option value="">All</option>' + 
                    sellers.map(s => `<option value="${s}">${s}</option>`).join('');
                
                applyFilters();
            };
            reader.readAsText(e.target.files[0]);
        };

        // Enable live filtering on seller dropdown via text input
        document.getElementById('sellerSearchInput').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            const options = document.getElementById('sellerNameSelect').options;
            for (let i = 1; i < options.length; i++) {
                const txt = options[i].text.toLowerCase();
                options[i].style.display = txt.includes(term) ? '' : 'none';
            }
        });

        // Event Listeners for Filters
        ['searchInput', 'negativeKeywords', 'storeSelect', 'sellerNameSelect', 'sortSelect', 
         'minPrice', 'maxPrice', 'minMRP', 'maxMRP', 'minDiscount', 'maxDiscount', 'dateMin', 'dateMax']
        .forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        document.getElementById('clearSearch').onclick = () => { document.getElementById('searchInput').value = ''; applyFilters(); };
        
        document.getElementById('jumpBtn').onclick = () => {
            const val = parseInt(document.getElementById('jumpInput').value);
            const max = Math.ceil(filteredData.length / pageSize);
            if(val > 0 && val <= max) { currentPage = val; renderCardsPage(filteredData, val); window.scrollTo(0,0); }
        };
    </script>
</body>
</html>
