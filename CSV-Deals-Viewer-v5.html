
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Deal Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        h1 { color: #333; font-weight: 700; font-size: 1.75rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 0.75rem; }
        
        .file-upload-section { background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 0.75rem; text-align: center; }
        #csvFile { max-width: 300px; cursor: pointer; }
        
        .search-bar { 
            max-width: 100%; 
            margin: 0.5rem 0 0.75rem; 
            background: white;
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .search-bar input { border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s ease; }
        .search-bar input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .search-bar .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; font-weight: 600; }
        .search-bar .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        
        .filter-bar { 
            background: white; 
            max-width: 100%; 
            margin: 0 0 0.3rem 0; 
            padding: 0.4rem;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .filter-bar input, .filter-bar select { 
            border: 1px solid #ddd; 
            border-radius: 3px; 
            transition: all 0.3s ease;
            font-size: 0.75rem;
            padding: 0.2rem 0.3rem !important;
            height: auto !important;
            min-height: 24px;
            margin: 0;
            overflow: hidden;
            word-break: break-word;
        }
        .filter-bar input:focus, .filter-bar select:focus { 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        .filter-bar label { font-weight: 600; color: #333; font-size: 0.65rem; margin-bottom: 0.1rem; margin-right: 0.2rem; white-space: nowrap; }
        .filter-bar h5 { font-size: 0.75rem; margin-bottom: 0.2rem; margin-top: 0.2rem; padding: 0.1rem 0; line-height: 1; }
        .filter-bar .col-md-3, .filter-bar .col-md-6, .filter-bar .col-md-12 { margin-bottom: 0.2rem; padding: 0.15rem; }
        .filter-bar .row { margin: 0 -0.15rem; }
        .filter-bar .custom-range { height: 6px; border-radius: 3px; }
        .filter-bar .custom-range::-webkit-slider-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; }
        
        .btn-success { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.3s ease;
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
            height: 26px;
            line-height: 1;
        }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4); }
        
        #hiddenCountDisplay { 
            font-weight: 700; 
            font-size: 0.85rem; 
            background: #fff3cd;
            color: #856404;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }
        
        .pagination-container { margin: 0.75rem 0; }
        .pagination { flex-wrap: wrap; justify-content: center; }
        .page-link { 
            min-width: 35px; 
            text-align: center; 
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            color: #667eea;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.15rem;
            padding: 0.3rem 0.5rem;
            font-size: 0.85rem;
        }
        .page-link:hover { border-color: #667eea; background: #f0f0f0; }
        .page-item.active .page-link { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }
        
        #pageJumpTop, #pageJumpBottom { display: flex !important; justify-content: center; margin: 1.5rem 0; }
        .pageJumpInput { 
            max-width: 150px !important; 
            min-width: 120px; 
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-weight: 600;
        }
        .jumpBtn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .card { 
            padding: 0.4rem; 
            border-radius: 8px; 
            border: none;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            background: white;
            max-width: 100%;
        }
        .card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.2);
        }
        
        .card-img-top { 
            max-height: 100px; 
            width: 100%; 
            object-fit: contain; 
            background: #ffffff;
            border-radius: 6px;
        }
        
        .card-body { padding: 0.5rem; overflow: hidden; }
        
        .card-title { 
            font-size: 0.85rem; 
            min-height: 2em; 
            font-weight: 600; 
            white-space: normal; 
            color: #333;
            line-height: 1.2;
            margin-bottom: 0.3rem;
            word-break: break-word;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .card-info { 
            font-size: 0.75rem; 
            color: #666; 
            margin-bottom: 0.4rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            overflow: hidden;
        }
        .card-info span { background: #f0f0f0; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; word-break: break-word; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .price-section { 
            padding: 0.25rem;
            border-radius: 6px;
            margin: 0.3rem 0;
        }
        
        .price-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.4rem;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
        }
        .price-row:last-child { margin-bottom: 0; }
        
        .price-item { 
            font-size: 1rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-weight: 800;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .highlight-highest { color: #d9534f; font-weight: bold; }
        .highlight-lowest { color: #5cb85c; font-weight: bold; }
        .highlight-average { color: #0275d8; font-weight: bold; }
        .highlight-discount { 
            color: #fff; 
            background: linear-gradient(135deg, #f0ad4e 0%, #ff8c42 100%);
            padding: 0.5rem 0.75rem; 
            border-radius: 6px; 
            font-weight: bold;
        }
        .highlight-price { 
            color: #fff; 
            background: linear-gradient(135deg, #070914 0%, #232323 100%);
            padding: 0.5rem 0.75rem; 
            border-radius: 6px; 
            font-weight: bold;
        }
        .highlight-average-price-diff { color: #555; font-weight: bold; }
        .highlight-mrp { color: #666; font-size: 0.9rem; }
        
        .action-buttons { 
            display: flex; 
            gap: 0.3rem;
            margin-top: 0.4rem;
        }
        
        .btn-buy-wide { 
            flex: 1;
            min-width: 70px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            padding: 0.3rem 0.4rem;
            font-size: 0.75rem;
        }
        .btn-buy-wide:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        
        .copy-btn { 
            margin-left: 0;
            font-size: 0.75em; 
            padding: 0.3rem 0.4rem; 
            min-width: 40px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s ease;
        }
        .copy-btn:hover { border-color: #667eea; background: #f0f0f0; }
        
        @media (max-width: 768px) {
            .container { padding: 0.5rem; margin: 0; }
            h1 { font-size: 1.3rem; margin-bottom: 0.5rem; }
            .filter-bar { padding: 0.75rem; }
            .filter-bar .col-md-3, .filter-bar .col-md-6 { margin-bottom: 0.5rem; }
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">üéØ CSV Deal Viewer</h1>
        <div class="file-upload-section">
            <label for="csvFile" style="font-weight: 600; color: #333; margin-bottom: 0.75rem; display: block;">üìÅ Upload Your CSV File</label>
            <input type="file" id="csvFile" accept=".csv" class="form-control-file d-inline-block">
        </div>
        <div class="search-bar input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="üîç Search by Name, Code, Store...">
            <div class="input-group-append">
                <button class="btn btn-primary" id="clearSearch" type="button">Clear</button>
            </div>
        </div>
        <div class="filter-bar row mb-3">
            <h5 class="col-12 mb-3" style="color: #333; font-weight: 700;">üí∞ Price & MRP Filters</h5>
            <div class="col-md-3 mb-2"><input type="number" id="minPrice" class="form-control" placeholder="Min Price"></div>
            <div class="col-md-3 mb-2"><input type="number" id="maxPrice" class="form-control" placeholder="Max Price"></div>
            <div class="col-md-3 mb-2"><input type="number" id="minMRP" class="form-control" placeholder="Min MRP"></div>
            <div class="col-md-3 mb-2"><input type="number" id="maxMRP" class="form-control" placeholder="Max MRP"></div>
            
            <h5 class="col-12 mb-3 mt-3" style="color: #333; font-weight: 700;">üè™ Store & Seller Filters</h5>
            <div class="col-md-3 mb-2"><select id="storeSelect" class="form-control" style="height:auto;"><option value="">All Stores</option></select></div>
            <div class="col-md-3 mb-2">
                <input type="text" id="sellerSearchInput" class="form-control" placeholder="üîç Search Seller..." style="margin-bottom: 0.2rem;">
                <select id="sellerNameSelect" class="form-control" style="height:auto;"><option value="">All Sellers</option></select>
            </div>
            
            <h5 class="col-12 mb-3 mt-3" style="color: #333; font-weight: 700;">üìä Additional Filters</h5>
            <div class="col-md-3 mb-2 d-flex align-items-center">
                <label for="discountRange" class="mr-2 mb-0" style="white-space:nowrap; font-weight: 600;">Discount:</label>
                <input type="range" id="discountRange" min="0" max="100" step="1" value="0" class="custom-range" style="flex:1;">
                <span id="discountRangeValue" class="ml-2" style="min-width:48px;display:inline-block; font-weight: 600;">0%+</span>
            </div>
            <div class="col-md-3 mb-2">
                <select id="sortSelect" class="form-control" style="height:auto;">
                    <option value="default">Sort: Default</option>
                    <option value="name-asc">Name ‚Üë</option>
                    <option value="name-desc">Name ‚Üì</option>
                    <option value="date-asc">Date ‚Üë</option>
                    <option value="date-desc">Date ‚Üì</option>
                    <option value="price-asc">Price ‚Üë</option>
                    <option value="price-desc">Price ‚Üì</option>
                    <option value="average-asc">Average ‚Üë</option>
                    <option value="average-desc">Average ‚Üì</option>
                    <option value="avg-price-diff-desc">Avg - Price ‚Üì</option>
                    <option value="avg-price-diff-asc">Avg - Price ‚Üë</option>
                    <option value="avg-price-diff-pct-desc">Avg - Price % ‚Üì</option>
                    <option value="avg-price-diff-pct-asc">Avg - Price % ‚Üë</option>
                </select>
            </div>
            <div class="col-md-6 mb-2">
                <input type="text" id="negativeKeywords" class="form-control" placeholder="Negative Keywords (comma separated)">
            </div>
            <div class="col-md-6 mb-2 d-flex align-items-center">
                <label for="dateMin" class="mr-2 mb-0" style="white-space:nowrap; font-weight: 600;">Date ‚â•</label>
                <input type="datetime-local" id="dateMin" class="form-control mr-2">
                <label for="dateMax" class="mr-2 mb-0" style="white-space:nowrap; font-weight: 600;">Date ‚â§</label>
                <input type="datetime-local" id="dateMax" class="form-control">
            </div>
            <div class="col-md-12 mb-2"><button class="btn btn-success btn-block" id="applyFilters">‚úì Apply Filters</button></div>
        </div>

        <div id="hiddenCountDisplay" class="text-center mb-3"></div>

        <nav id="paginationTop" class="pagination-container d-none"><ul class="pagination justify-content-center"></ul></nav>
        <div id="pageJumpTop" class="justify-content-center mb-4 d-none"></div>

        <div id="cardContainer" class="row"></div>

        <nav id="paginationBottom" class="pagination-container d-none mt-4"><ul class="pagination justify-content-center"></ul></nav>
        <div id="pageJumpBottom" class="justify-content-center mt-2 mb-5 d-none"></div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const pageSize = 60;
        let hiddenByNegativeCount = 0;

        function optimizeImageUrl(url) {
            // Replace Flipkart image URLs
            url = url.replace(/flixcart\.com\/image\/\d+\/\d+\//g, 'flixcart.com/image/250/250/');
            // Replace Amazon image URLs - insert ._SS150_FMwebp_ before file extension
            url = url.replace(/(\/images\/I\/[^.]+)\.jpg/g, '$1._SS250_FMwebp_.jpg');
            return url;
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(Boolean);
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = [];
                let cur = '', inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { values.push(cur); cur = ''; }
                    else cur += char;
                }
                values.push(cur);
                const obj = {};
                headers.forEach((h, i) => obj[h.trim()] = (values[i] || '').replace(/^"|"$/g, ''));
                return obj;
            });
        }

        function renderCardsPage(data, page) {
            const container = document.getElementById('cardContainer');
            const hiddenDisplay = document.getElementById('hiddenCountDisplay');
            hiddenDisplay.textContent = hiddenByNegativeCount > 0 ? `Items hidden by negative keywords: ${hiddenByNegativeCount}` : '';

            if (!data.length) {
                container.innerHTML = '<div class="text-center text-muted col-12">No results found.</div>';
                togglePaginationUI(false);
                return;
            }
            
            togglePaginationUI(true);
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, data.length);
            const pageData = data.slice(start, end);

            container.innerHTML = pageData.map((row, idx) => {
                let buyUrl = '';
                let storeName = row.Store;
                
                if (row.Store === '1') {
                    buyUrl = `https://www.amazon.in/pricehistory_app/dp/${row.Code}`;
                    storeName = 'Amazon';
                } else if (row.Store === '2') {
                    buyUrl = `https://www.flipkart.com/pricehistory_app-dealsspy/p/b?pid=${row.Code}`;
                    storeName = 'Flipkart';
                } else if (row.Store === '4') {
                    buyUrl = `https://www.amazon.com/pricehistory_app/dp/${row.Code}`;
                    storeName = 'Amazon_US';
                }

                let highest = parseInt(row.Highest) || '-';
                let lowest = parseInt(row.Lowest) || '-';
                let average = parseInt(row.Average) || '-';
                let price = parseInt(row.Price) || '-';
                let mrp = parseInt(row.MRP) || '-';
                let avgPriceDiff = (!isNaN(row.Average) && !isNaN(row.Price)) ? (parseInt(row.Average) - parseInt(row.Price)).toLocaleString('en-IN') : '-';
                let sellerName = row.SellerName || (row.SellerId ? 'Seller ' + row.SellerId : '-');
                let discount = row.Discount ? row.Discount + '%' : '-';

                return `
            <div class="col-12 col-sm-6 col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <img class="card-img-top card-img-large" src="${optimizeImageUrl(row.Image)}" alt="${row.Name}" loading="lazy">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title mb-2" title="${row.Name}">${row.Name}</h5>
                        <div class="card-info">
                            <span title="Added Date">${row.AddedOn}</span>
                            <span title="Seller">${sellerName}</span>
                            <span title="Store">${storeName}</span>
                            <span title="Product Code">${row.Code}</span>
                        </div>
                        <div class="price-section flex-grow-1">
                            <div class="price-row">
                                <div class="price-item">Highest: <span class="highlight-highest">‚Çπ${highest}</span></div>
                                <div class="price-item">Average: <span class="highlight-average">‚Çπ${average}</span></div>
                                <div class="price-item">Lowest: <span class="highlight-lowest">‚Çπ${lowest}</span></div>
                            </div>
                            <div class="price-row">
                                <div class="price-item">Diff: <span class="highlight-average-price-diff">‚Çπ${avgPriceDiff}</span></div>
                                <div class="price-item highlight-mrp">MRP: ‚Çπ${mrp}</div>
                            </div>
                            <div class="price-row mt-3 pt-3" style="border-top: 2px solid rgba(0,0,0,0.1);">
                                <div class="price-item highlight-price" style="flex: 1;">‚Çπ${price}</div>
                                <div class="price-item highlight-discount">${discount}</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${buyUrl ? `<a href="${buyUrl}" target="_blank" class="btn btn-sm btn-buy-wide">üõí Buy</a>` : ''}
                            <button class="btn btn-sm copy-btn" data-url="${buyUrl}">üìã Copy</button>
                        </div>
                    </div>
                </div>
            </div>`;
            }).join('');

            renderPagination('paginationTop', data.length, page);
            renderPagination('paginationBottom', data.length, page);
            renderJumpUI('pageJumpTop', data.length);
            renderJumpUI('pageJumpBottom', data.length);
            attachCopyEvents();
        }

        function togglePaginationUI(show) {
            const elements = ['paginationTop', 'paginationBottom', 'pageJumpTop', 'pageJumpBottom'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (show) { el.classList.remove('d-none'); el.classList.add('d-flex'); }
                else { el.classList.add('d-none'); el.classList.remove('d-flex'); }
            });
        }

        function renderPagination(containerId, total, page) {
            const nav = document.getElementById(containerId);
            const ul = nav.querySelector('ul');
            const pageCount = Math.ceil(total / pageSize);
            ul.innerHTML = '';
            const addPage = (p, text, active = false, disabled = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${text}</a>`;
                if (!disabled) li.onclick = (e) => { e.preventDefault(); currentPage = p; renderCardsPage(filteredData, p); window.scrollTo(0,0); };
                ul.appendChild(li);
            };
            addPage(page - 1, 'Previous', false, page === 1);
            for (let i = Math.max(1, page - 2); i <= Math.min(pageCount, page + 2); i++) addPage(i, i, i === page);
            addPage(page + 1, 'Next', false, page === pageCount);
        }

        function renderJumpUI(containerId, total) {
            const container = document.getElementById(containerId);
            const pageCount = Math.ceil(total / pageSize);
            container.innerHTML = `
                <div class="input-group" style="max-width:200px;">
                    <input type="number" class="form-control pageJumpInput" min="1" max="${pageCount}" placeholder="Go to page">
                    <div class="input-group-append"><button class="btn btn-outline-secondary jumpBtn" type="button">Go</button></div>
                </div>`;
            const input = container.querySelector('input');
            const btn = container.querySelector('button');
            const doJump = () => {
                const val = parseInt(input.value);
                if (val >= 1 && val <= pageCount) { currentPage = val; renderCardsPage(filteredData, val); window.scrollTo(0,0); }
            };
            btn.onclick = doJump;
            input.onkeyup = (e) => { if(e.key === 'Enter') doJump(); };
        }

        function getFilteredAndSearchedData() {
            let data = [...allData];
            const minP = parseFloat(document.getElementById('minPrice').value);
            const maxP = parseFloat(document.getElementById('maxPrice').value);
            const minM = parseFloat(document.getElementById('minMRP').value);
            const maxM = parseFloat(document.getElementById('maxMRP').value);
            const store = document.getElementById('storeSelect').value;
            const disc = parseInt(document.getElementById('discountRange').value) || 0;
            const seller = document.getElementById('sellerNameSelect').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const neg = document.getElementById('negativeKeywords').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
            const dateMin = document.getElementById('dateMin').value ? new Date(document.getElementById('dateMin').value) : null;
            const dateMax = document.getElementById('dateMax').value ? new Date(document.getElementById('dateMax').value) : null;

            if (!isNaN(minP)) data = data.filter(r => parseFloat(r.Price) >= minP);
            if (!isNaN(maxP)) data = data.filter(r => parseFloat(r.Price) <= maxP);
            if (!isNaN(minM)) data = data.filter(r => parseFloat(r.MRP) >= minM);
            if (!isNaN(maxM)) data = data.filter(r => parseFloat(r.MRP) <= maxM);
            if (store) data = data.filter(r => r.Store === store);
            if (seller) data = data.filter(r => (r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')) === seller);
            if (disc > 0) data = data.filter(r => parseInt(r.Discount) >= disc);
            if (dateMin) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) >= dateMin);
            if (dateMax) data = data.filter(r => r.AddedOn && new Date(r.AddedOn) <= dateMax);
            if (search) data = data.filter(r => `${r.Name} ${r.Code}`.toLowerCase().includes(search));

            const preNegLength = data.length;
            if (neg.length) data = data.filter(r => !neg.some(w => `${r.Name} ${r.Code} ${r.Store}`.toLowerCase().includes(w)));
            hiddenByNegativeCount = preNegLength - data.length;

            const sortVal = document.getElementById('sortSelect').value;
            data.sort((a, b) => {
                const valA = parseFloat(a.Price) || 0;
                const valB = parseFloat(b.Price) || 0;
                const avgA = parseFloat(a.Average) || 0;
                const avgB = parseFloat(b.Average) || 0;

                switch (sortVal) {
                    case 'name-asc': return (a.Name || '').localeCompare(b.Name || '');
                    case 'name-desc': return (b.Name || '').localeCompare(a.Name || '');
                    case 'date-asc': return new Date(a.AddedOn || 0) - new Date(b.AddedOn || 0);
                    case 'date-desc': return new Date(b.AddedOn || 0) - new Date(a.AddedOn || 0);
                    case 'price-asc': return valA - valB;
                    case 'price-desc': return valB - valA;
                    case 'average-asc': return avgA - avgB;
                    case 'average-desc': return avgB - avgA;
                    case 'avg-price-diff-desc': return (avgB - valB) - (avgA - valA);
                    case 'avg-price-diff-asc': return (avgA - valA) - (avgB - valB);
                    case 'avg-price-diff-pct-desc':
                        const pctA = valA ? (avgA - valA) / valA : -Infinity;
                        const pctB = valB ? (avgB - valB) / valB : -Infinity;
                        return pctB - pctA;
                    case 'avg-price-diff-pct-asc':
                        const pctA_asc = valA ? (avgA - valA) / valA : Infinity;
                        const pctB_asc = valB ? (avgB - valB) / valB : Infinity;
                        return pctA_asc - pctB_asc;
                    default: return 0;
                }
            });

            return data;
        }

        function applyFilters() {
            filteredData = getFilteredAndSearchedData();
            currentPage = 1;
            renderCardsPage(filteredData, currentPage);
        }

        function attachCopyEvents() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.onclick = function () {
                    const url = this.getAttribute('data-url');
                    if (url) {
                        navigator.clipboard.writeText(url);
                        const oldText = this.textContent;
                        this.textContent = 'Copied!';
                        setTimeout(() => { this.textContent = oldText; }, 1200);
                    }
                };
            });
        }

        document.getElementById('csvFile').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                allData = parseCSV(evt.target.result);
                const storeMap = { '1': 'Amazon', '2': 'Flipkart', '4': 'Amazon_US' };
                const stores = Array.from(new Set(allData.map(r => r.Store))).filter(Boolean);
                document.getElementById('storeSelect').innerHTML = '<option value="">All Stores</option>' + 
                    stores.map(s => `<option value="${s}">${storeMap[s] || s}</option>`).join('');
                const sellers = Array.from(new Set(allData.map(r => r.SellerName || (r.SellerId ? 'Seller ' + r.SellerId : '')))).filter(Boolean).sort();
                document.getElementById('sellerNameSelect').innerHTML = '<option value="">All Sellers</option>' + 
                    sellers.map(s => `<option value="${s}">${s}</option>`).join('');
                
                // Add seller search functionality
                document.getElementById('sellerSearchInput').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const options = document.getElementById('sellerNameSelect').options;
                    for (let i = 1; i < options.length; i++) {
                        options[i].style.display = options[i].text.toLowerCase().includes(searchTerm) ? '' : 'none';
                    }
                });
                
                applyFilters();
            };
            reader.readAsText(e.target.files[0]);
        };

        ['searchInput', 'negativeKeywords', 'storeSelect', 'sellerNameSelect', 'sortSelect', 'minPrice', 'maxPrice', 'minMRP', 'maxMRP', 'dateMin', 'dateMax'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        document.getElementById('discountRange').oninput = function() {
            document.getElementById('discountRangeValue').textContent = this.value + '%+';
            applyFilters();
        };

        document.getElementById('clearSearch').onclick = () => { document.getElementById('searchInput').value = ''; applyFilters(); };
    </script>
</body>
</html>


